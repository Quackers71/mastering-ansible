## Mastering Ansible
# Servers & IP's 
              IP:
1. dnsmasq  - 192.168.0.40
2. ubuntu-c - 192.168.0.41
3. ubuntu1  - 192.168.0.42
4. ubuntu2  - 192.168.0.43  
5. centos1  - 192.168.0.45
6. centos2  - 192.168.0.46
7. centos3  - 192.168.0.47
8. robq-VirtualBox     - 192.168.0.48

Here's the link to the different VMs: https://drive.google.com/drive/u/1/folders/1QBgNs6knbwpSPyUMexDXhKjv3TO_Ka55

# N.B. because you keep Hibernating the Host you may need to restart the NetworkManager Service using :
sudo systemctl restart NetworkManager.service

# Install ansible on Linux robq-VirtualBox
sudo apt-add-repository ppa:ansible/ansible
sudo apt update
sudo apt install ansible
# other installations can be viewed at : 
https://github.com/Quackers71/ps-h-o-ansible/blob/master/Installation.txt

# Add the .pub key to all the hosts
robq@robq-VirtualBox:~/mastering-ansible/ansible$ for host in /
192.168.0.41 192.168.0.42 192.168.0.43 192.168.0.46 192.168.0.47; do ssh-copy-id ${host}; done

# ansible host commands
ansible all -m ping
ansible centos --list-hosts
ansible ubuntu --list-hosts
ansible all --list-hosts
ansible ~.*3 --list-hosts

# Changing centos1 port to 2222
ssh root@192.168.0.45
vim /etc/ssh/sshd_config
# change to 
Port 2222
# now run
-bash-4.2# semanage port -a -t ssh_port_t -p tcp 2222
-bash: semanage: command not found
-bash-4.2# yum install policycoreutils-python -y

-bash-4.2# semanage port -a -t ssh_port_t -p tcp 2222
ValueError: Port tcp/2222 already defined

-bash-4.2# firewall-cmd --permanent --add-port=2222/tcp
success
-bash-4.2# firewall-cmd --reload
success

-bash-4.2# service sshd restart
Redirecting to /bin/systemctl restart sshd.service

-bash-4.2# ssh 0 -p 2222
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '[0]:2222,[0.0.0.0]:2222' (ECDSA) to the list of known hosts.
root@0's password: 
Last login: Sun Jul 14 21:17:31 2019

## Ansible Inventories

https://docs.ansible.com/ansible/2.3/intro_inventory.html

https://docs.ansible.com/ansible/latest/user_guide/vault.html


## Ansible Modules

date
# The 'file' Module
ansible all -m file -a 'path=/tmp/test state=touch'
# Yellow Output = Success but shows 'CHANGED'
ls -altrh /tmp/test
ansible all -m file -a 'path=/tmp/test state=touch'
# Yellow Output
ls -altrh /tmp/test
ansible all -m file -a 'path=/tmp/test state=file mode=600'
# Yellow Output
ansible all -m file -a 'path=/tmp/test state=file mode=600'
# Green Output = Success (no change)


# Idempotency - An operation is Idempotent
# if the result of performing it once is 
# exactly the same as the result of performing
# it repeatedly without any intervening actions.


# The 'copy' Module
touch /tmp/x
ansible all -m copy -a 'src=/tmp/x dest=/tmp/x'
ansible all -m copy -a 'remote_src=yes src=/tmp/x dest=/tmp/y'


# The 'command' Module
robq@robq-VirtualBox:~/mastering-ansible/ansible$ ansible all -m command -a 'hostname' -o
robq-VirtualBox | CHANGED | rc=0 | (stdout) robq-VirtualBox
ubuntu1 | CHANGED | rc=0 | (stdout) ubuntu1
centos1 | CHANGED | rc=0 | (stdout) centos1
centos3 | CHANGED | rc=0 | (stdout) centos3
centos2 | CHANGED | rc=0 | (stdout) centos2
ubuntu2 | CHANGED | rc=0 | (stdout) ubuntu2
ubuntu3 | CHANGED | rc=0 | (stdout) ubuntu-c


# Argument 'id'
robq@robq-VirtualBox:~/mastering-ansible/ansible$ ansible all -a 'id'
 [WARNING]: Platform linux on host robq-VirtualBox is using the discovered Python interpreter at /usr/bin/python, but future installation of another Python interpreter could change this. See
https://docs.ansible.com/ansible/2.8/reference_appendices/interpreter_discovery.html for more information.

robq-VirtualBox | CHANGED | rc=0 >>
uid=1000(robq) gid=1000(robq) groups=1000(robq),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),112(lpadmin),128(sambashare)

ubuntu1 | CHANGED | rc=0 >>
uid=0(root) gid=0(root) groups=0(root)

centos1 | CHANGED | rc=0 >>
uid=1000(packt) gid=1000(packt) groups=1000(packt),10(wheel) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023

centos2 | CHANGED | rc=0 >>
uid=1000(packt) gid=1000(packt) groups=1000(packt),10(wheel) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023

centos3 | CHANGED | rc=0 >>
uid=1000(packt) gid=1000(packt) groups=1000(packt),10(wheel) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023

ubuntu2 | CHANGED | rc=0 >>
uid=0(root) gid=0(root) groups=0(root)

ubuntu3 | CHANGED | rc=0 >>
uid=0(root) gid=0(root) groups=0(root)


# The 'creates' Module
ansible all -a 'touch /tmp/test_copy_module creates=/tmp/test_copy_module'
centos1 | CHANGED | rc=0 >>

ansible all -a 'touch /tmp/test_copy_module creates=/tmp/test_copy_module'
robq-VirtualBox | SUCCESS | rc=0 >>
skipped, since /tmp/test_copy_module exists


# The 'removes' Module
ansible all -a 'rm /tmp/test_copy_module removes=/tmp/test_copy_module'
robq-VirtualBox | CHANGED | rc=0 >>

ansible all -a 'rm /tmp/test_copy_module removes=/tmp/test_copy_module'
robq-VirtualBox | SUCCESS | rc=0 >>
skipped, since /tmp/test_copy_module does not exist


#Argument state=absent
ansible all -m file -a 'path=/tmp/test_copy_module state=absent'

# Create a file on Centos1 and then copy it locally
ansible centos1 -m file -a 'path=/tmp/test_modules.txt state=touch mode=600'
ansible centos1 -m fetch -a 'src=/tmp/test_modules.txt dest=/tmp/test_modules.txt'
robq@robq-VirtualBox:~/mastering-ansible/ansible$ ls -lart /tmp/test_modules.txt/centos1/tmp/test_modules.txt 
-rw------- 1 robq robq 0 Jul 14 01:33 /tmp/test_modules.txt/centos1/tmp/test_modules.txt

# Using Ansible Doc
ansible-doc find
ansible-doc fetch 
# etc...

## YAML

Resources:
http://yaml-online-parser.appspot.com
http://yaml.org/spec/1.2/spec.html
https://en.wikipedia.org/wiki/YAML
https://stackoverflow.com/questions/3790454/in-yaml-how-do-i-break-a-string-over-multiple-lines


Example #07:

robq@robq-VirtualBox:~/Mastering-Ansible/02 - Ansible Architecture and Design/03 - YAML/07$ cat test.yml 
# Every YAML file should start with three dashes
---

example_key_1: >-
  this is a string
  that goes over
  multiple lines
 
# Every YAML file should end with three dots
...
robq@robq-VirtualBox:~/Mastering-Ansible/02 - Ansible Architecture and Design/03 - YAML/07$ ./show_yaml_python.py 
{'example_key_1': 'this is a string that goes over multiple lines'}



## Further notes created on 03/11/2019
## lists & dictionaries

robq@robq-VirtualBox:~/Mastering-Ansible/02 - Ansible Architecture and Design/03 - YAML/02$ ./show_yaml_python.py 
{'example_key_1': 'this is a string',
 'example_key_2': 'this is another string'}

# Output 'Python' is treating the above as a dictionary given the curly brackets
# The below shows how you can lookup a value by the key...

robq@robq-VirtualBox:~/Mastering-Ansible/02 - Ansible Architecture and Design/03 - YAML/02$ python
Python 2.7.15+ (default, Oct  7 2019, 17:39:04) 
[GCC 7.4.0] on linux2
Type "help", "copyright", "credits" or "license" for more information.
>>> myvar = {'example_key_1': 'this is a string', 'example_key_2': 'this is another string'}
>>> print (myvar)
{'example_key_2': 'this is another string', 'example_key_1': 'this is a string'}
>>> print (myvar['example_key_1'])
this is a string
>>> print (myvar['example_key_2'])
this is another string
>>> 

robq@robq-VirtualBox:~/Mastering-Ansible/02 - Ansible Architecture and Design/03 - YAML/07$ cat test.yml 
# Every YAML file should start with three dashes
---

example_key_1: >-
  this is a string
  that goes over
  multiple lines
 
# Every YAML file should end with three dots
...
robq@robq-VirtualBox:~/Mastering-Ansible/02 - Ansible Architecture and Design/03 - YAML/07$ ./show_yaml_python.py 
{'example_key_1': 'this is a string that goes over multiple lines'}

# The > will format over the value over one line
# The >- will strip the /n from the output of the value


## lists

robq@robq-VirtualBox:~/Mastering-Ansible/02 - Ansible Architecture and Design/03 - YAML/11$ cat test.yml 
---
# Every YAML file should start with three dashes

- item 1
- item 2
- item 3
- item 4
- item 5

# Every YAML file should end with three dots
...
robq@robq-VirtualBox:~/Mastering-Ansible/02 - Ansible Architecture and Design/03 - YAML/11$ ./show_yaml_python.py 
['item 1', 'item 2', 'item 3', 'item 4', 'item 5']
robq@robq-VirtualBox:~/Mastering-Ansible/02 - Ansible Architecture and Design/03 - YAML/11$ 

# In Python
Python 2.7.15+ (default, Oct  7 2019, 17:39:04) 
[GCC 7.4.0] on linux2
Type "help", "copyright", "credits" or "license" for more information.
>>> myvar = ['item 1', 'item 2', 'item 3', 'item 4', 'item 5']
>>> print(myvar)
['item 1', 'item 2', 'item 3', 'item 4', 'item 5']
>>> print(myvar[0])
item 1
>>> print(type(myvar))
<type 'list'>
>>> 

# dictionary of lists
robq@robq-VirtualBox:~/Mastering-Ansible/02 - Ansible Architecture and Design/03 - YAML/17$ cat test.yml 
---
# Every YAML file should start with three dashes

example_key_1:
  - list item 1
  - list item 2

example_key_2:
  - list item 3
  - list item 4

# Every YAML file should end with three dots
...
robq@robq-VirtualBox:~/Mastering-Ansible/02 - Ansible Architecture and Design/03 - YAML/17$ ./show_yaml_python.py 
{'example_key_1': ['list item 1', 'list item 2'],
 'example_key_2': ['list item 3', 'list item 4']}

# list of dictionaries
robq@robq-VirtualBox:~/Mastering-Ansible/02 - Ansible Architecture and Design/03 - YAML/18$ cat test.yml 
---
# Every YAML file should start with three dashes

- example_1: 
  - item_1
  - item_2
  - item_3

- example_2: 
  - item_4
  - item_5
  - item_6

# Every YAML file should end with three dots
...
robq@robq-VirtualBox:~/Mastering-Ansible/02 - Ansible Architecture and Design/03 - YAML/18$ ./show_yaml_python.py 
[{'example_1': ['item_1', 'item_2', 'item_3']},
 {'example_2': ['item_4', 'item_5', 'item_6']}]

 # dictionary consisting of a list of dictionaries each one consisting of a list of items
 robq@robq-VirtualBox:~/Mastering-Ansible/02 - Ansible Architecture and Design/03 - YAML/19$ cat test.yml 
---
# Every YAML file should start with three dashes

example_dictionary_1:
  - example_dictionary_2:
    - 1
    - 2
    - 3
  - example_dictionary_2:
    - 4
    - 5
    - 6
  - example_dictionary_4:
    - 7
    - 8
    - 9

# Every YAML file should end with three dots
...
robq@robq-VirtualBox:~/Mastering-Ansible/02 - Ansible Architecture and Design/03 - YAML/19$ ./show_yaml_python.py 
{'example_dictionary_1': [{'example_dictionary_2': [1, 2, 3]},
                          {'example_dictionary_2': [4, 5, 6]},
                          {'example_dictionary_4': [7, 8, 9]}]}

Example #22:

robq@robq-VirtualBox:~/Mastering-Ansible/02 - Ansible Architecture and Design/03 - YAML/22$ cat test.yml 
---
# Every YAML file should start with three dashes

- Aston Martin:
    year_founded: 1913
    website: astonmartin.com
    founded_by:
      - Lionel Martin
      - Robert Bamford
- Fiat:
    year_founded: 1899
    website: fiat.com
    founded_by: 
      - Giovanni Agnelli
- Ford:
    year_founded: 1903
    website: ford.com
    founded_by:
      - Henry Ford  
- Vauxhall:
    year_founded: 1857
    website: vauxhall.co.uk
    founded_by:
      - Alexander Wilson 

# Every YAML file should end with three dots
...
robq@robq-VirtualBox:~/Mastering-Ansible/02 - Ansible Architecture and Design/03 - YAML/22$ ./show_yaml_python.py 
[{'Aston Martin': {'founded_by': ['Lionel Martin', 'Robert Bamford'],
                   'website': 'astonmartin.com',
                   'year_founded': 1913}},
 {'Fiat': {'founded_by': ['Giovanni Agnelli'],
           'website': 'fiat.com',
           'year_founded': 1899}},
 {'Ford': {'founded_by': ['Henry Ford'],
           'website': 'ford.com',
           'year_founded': 1903}},
 {'Vauxhall': {'founded_by': ['Alexander Wilson'],
               'website': 'vauxhall.co.uk',
               'year_founded': 1857}}]



## Ansible Playbooks, Breakdown on Sections
# Re-watched this section on 04/11/2019 :-)

# Frickme!   ???
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/02-04-02$ time ansible-playbook motd_playbook.yml -K
BECOME password: 

PLAY [centos] ****************************************************************************************************

TASK [Gathering Facts] *******************************************************************************************
ok: [centos2]
ok: [centos1]
ok: [centos3]

TASK [Configure a MOTD (message of the day)] *********************************************************************
ok: [centos2]
ok: [centos3]
ok: [centos1]

PLAY RECAP *******************************************************************************************************
centos1                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
centos2                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
centos3                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


real	0m8.445s
user	0m3.163s
sys	0m0.915s

# Further ansible-playbook commands

ansible-playbook motd_playbook.yml -K -e 'motd="Testing the motd playbook\n"'

ansible-playbook motd_playbook.yml -K -e 'motd_centos="Testing the motd playbook\n"'

ansible-playbook motd_playbook.yml -K -e 'motd_ubuntu="Testing the motd playbook\n"'

# e.g.

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/02-04-02$ ansible-playbook motd_playbook.yml -K -e 'motd_ubuntu="Testing the motd playbook\n"'
BECOME password: 

PLAY [linux] ********************************************************************************************************************************************

TASK [Gathering Facts] **********************************************************************************************************************************
ok: [ubuntu1]
ok: [ubuntu2]
ok: [centos3]
ok: [centos2]
ok: [centos1]
ok: [ubuntu3]

TASK [Configure a MOTD (message of the day)] ************************************************************************************************************
skipping: [ubuntu1]
skipping: [ubuntu2]
skipping: [ubuntu3]
changed: [centos2]
changed: [centos1]
changed: [centos3]

TASK [Configure a MOTD (message of the day)] ************************************************************************************************************
skipping: [centos3]
skipping: [centos2]
skipping: [centos1]
changed: [ubuntu1]
changed: [ubuntu2]
changed: [ubuntu3]

RUNNING HANDLER [MOTD changed] **************************************************************************************************************************
ok: [centos2] => {
    "msg": "The MOTD was changed"
}
ok: [centos1] => {
    "msg": "The MOTD was changed"
}
ok: [centos3] => {
    "msg": "The MOTD was changed"
}
ok: [ubuntu1] => {
    "msg": "The MOTD was changed"
}
ok: [ubuntu2] => {
    "msg": "The MOTD was changed"
}
ok: [ubuntu3] => {
    "msg": "The MOTD was changed"
}

PLAY RECAP **************************************************************************************************************************************************************************************
centos1                    : ok=3    changed=1    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   
centos2                    : ok=3    changed=1    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   
centos3                    : ok=3    changed=1    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   
ubuntu1                    : ok=3    changed=1    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   
ubuntu2                    : ok=3    changed=1    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   
ubuntu3                    : ok=3    changed=1    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/02-04-02$



## Ansible Playbooks, Variables
# Re-watched this section and made some files changes on 04/11/2019

# New files added i.e. variables_playbook#.yml
ansible-playbook variables_playbook#.yml

# Used for Example playbook16
ansible-playbook variables_playbook16.yml -e 'extra_vars_key="extra vars value"'
ok: [centos1] => {
    "msg": "extra vars value"

# & json format
ansible-playbook variables_playbook16.yml -e '{"extra_vars_key": "extra vars value in json"}'
ok: [centos1] => {
    "msg": "extra vars value in json"

# yaml format - USE THIS ONE!!!
ansible-playbook variables_playbook16.yml -e '{extra_vars_key: extra vars value in yaml}'
ok: [centos1] => {
    "msg": "extra vars value in yaml"


# playbook17
ansible-playbook variables_playbook17.yml -e @extra_vars_file.yml
ok: [centos1] => {
    "msg": "extra vars value"
}

ansible-playbook variables_playbook17.yml -e @extra_vars_file.json
ok: [centos1] => {
    "msg": "extra vars value"
}



# Ansible Playbooks, Facts
# Re-watched this section on 04/11/2019

- Facts
- The setup module and how this relates to fact gathering
- Filtering for specific facts
- The creation of custom facts
- The execution of custom facts
- How custom facts can be used in environments without super user access

# facts_playbook1.yml
ansible centos1 -m setup -a'gather_subset=network'
# Word Count using '| wc -l'
ansible centos1 -m setup -a'gather_subset=network' | wc -l

ansible centos1 -m setup -a'gather_subset=network,!all,!min' | wc -l

ansible centos1 -m setup -a 'filter=ansible_memfree_mb'
centos1 | SUCCESS => {
    "ansible_facts": {
        "ansible_memfree_mb": 136, 
        "discovered_interpreter_python": "/usr/bin/python"
    }, 
    "changed": false
}

# Using the wildcard *
ansible centos1 -m setup -a'filter=ansible_mem*'


# getdate1 & getdate2
# both these files are within the /templates directory
# 1. Json format
$ ./getdate1.fact   
{"date" : "Sun  4 Aug 21:41:01 BST 2019"}
# 2. Ini format
$ ./getdate2.fact 
[date]
date=Sun 4 Aug 21:41:05 BST 2019


sudo mkdir /etc/ansible/facts.d
sudo cp * /etc/ansible/facts.d/
ls -larth /etc/ansible/facts.d/
/etc/ansible/facts.d/getdate1.fact 
/etc/ansible/facts.d/getdate2.fact

ansible robq-VirtualBox -m setup | tee /tmp/x

# Output in /etc/x using vim
ansible_local": {
            "getdate1": {
                "date": "Sun  4 Aug 21:36:54 BST 2019"
            },
            "getdate2": {
                "date": {
                    "date": "Sun 4 Aug 21:36:54 BST 2019"
                }
            }
        },


# Use this for a better Output
$ ansible robq-VirtualBox -m setup -a 'filter=ansible_local'

robq-VirtualBox | SUCCESS => {
    "ansible_facts": {
        "ansible_local": {
            "getdate1": {
                "date": "Sun  4 Aug 21:44:15 BST 2019"
            }, 
            "getdate2": {
                "date": {
                    "date": "Sun 4 Aug 21:44:15 BST 2019"
                }
            }
        }, 
        "discovered_interpreter_python": "/usr/bin/python"
    }, 
    "changed": false
}

# Running the facts_playbook3 & 4 just on robq-VirtualBox (The Ansible Controller)
ansible-playbook facts_playbook3.yml -l robq-VirtualBox

PLAY [all] ************************************************************

TASK [Gathering Facts] ************************************************
ok: [robq-VirtualBox]

TASK [Show IP Address] ************************************************
ok: [robq-VirtualBox] => {
    "msg": "192.168.0.48"
}

TASK [Show Custom Fact 1] *********************************************
ok: [robq-VirtualBox] => {
    "msg": "Sun  4 Aug 22:17:01 BST 2019"
}

TASK [Show Custom Fact 2] *********************************************
ok: [robq-VirtualBox] => {
    "msg": "Sun 4 Aug 22:17:01 BST 2019"
}

PLAY RECAP ************************************************************
robq-VirtualBox                       : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

ansible-playbook facts_playbook4.yml -l robq-VirtualBox

# Copying the getdates.facts to the Linux Group
ansible-playbook facts_playbook5.yml

# Remove getdate#.fact from all the hosts :
ansible all -m file -a 'path=/etc/ansible/facts.d/getdate1.fact state=absent' -o
ansible all -m file -a 'path=/etc/ansible/facts.d/getdate2.fact state=absent' -o

sudo rm -rf /etc/ansible-facts.d/*

# Run the last playbook to copy the getdate scripts using /home/packt user
ansible-playbook facts_playbook6.yml

# Again cleanup the scripts from all linux hosts
$ ansible linux -m file -a 'path=/home/packt/ansible/facts.d state=absent'



## Templating with Jinja2
- The Jinja2 templating language
- if/elif/else statements
- for loops
- break and continue
- ranges
- Jinja2 filters

# Jinja2_Playbook3
$ ansible-playbook jinja2_playbook3.yml 

PLAY [all] ********************************************************************************************************

TASK [Gathering Facts] ********************************************************************************************
ok: [ubuntu1]
ok: [robq-VirtualBox]
ok: [ubuntu2]
ok: [ubuntu3]
ok: [centos3]
ok: [centos1]
ok: [centos2]

TASK [Ansible Jinja2 if elif else] ********************************************************************************
ok: [robq-VirtualBox] => {
    "msg": "--== Ansible Jinja2 if elif else statement ==--\nThis is robq-VirtualBox\n"
}
ok: [centos3] => {
    "msg": "--== Ansible Jinja2 if elif else statement ==--\nThis is good old centos3\n"
}
ok: [centos2] => {
    "msg": "--== Ansible Jinja2 if elif else statement ==--\nThis is good old centos2\n"
}
ok: [centos1] => {
    "msg": "--== Ansible Jinja2 if elif else statement ==--\nThis is centos1 with it's modified SSH Port\n"
}
ok: [ubuntu1] => {
    "msg": "--== Ansible Jinja2 if elif else statement ==--\nThis is good old ubuntu1\n"
}
ok: [ubuntu2] => {
    "msg": "--== Ansible Jinja2 if elif else statement ==--\nThis is good old ubuntu2\n"
}
ok: [ubuntu3] => {
    "msg": "--== Ansible Jinja2 if elif else statement ==--\nThis is good old ubuntu3\n"
}

PLAY RECAP ********************************************************************************************************
centos1                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
centos2                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
centos3                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
robq-VirtualBox            : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ubuntu1                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ubuntu2                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ubuntu3                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

$ ansible-playbook jinja2_playbook11.yml 
$ cat /tmp/robq-VirtualBox_template.out 
--== Ansible Jinja2 if statement ==--

This is robq-VirtualBox

--== Ansible Jinja2 if elif statement ==--

This is robq-VirtualBox

--== Ansible Jinja2 if elif else statement ==--

This is robq-VirtualBox

--== Ansible Jinja2 if variable is defined ( where variable is not defined ) ==--

example_variable is not defined

--== Ansible Jinja2 if varible is defined ( where variable is defined ) ==--

example_variable is defined

--== Ansible Jinja2 for statement ==--

IP Address entry 1 = 10.0.4.15
IP Address entry 2 = 192.168.1.41
IP Address entry 3 = 192.168.0.48

--== Ansible Jinja2 for range

1
2
3
4
5
6
7
8
9
10

--== Ansible Jinja2 for range, reversed (simulate while greater 5) ==--

10
9
8
7
6

--== Ansible Jinja2 for range, reversed (continue if odd) ==--

10
8
6
4
2

---=== Ansible Jinja2 filters ===---

--== min [1, 2, 3, 4, 5] ==--

1

--== max [1, 2, 3, 4, 5] ==--

5

--== unique [1, 1, 2, 2, 3, 3, 4, 4, 5, 5] ==--

[1, 2, 3, 4, 5]

--== difference [1, 2, 3, 4, 5] vs [2, 3, 4, 5, 6] ==--

[1, 5]

--== random ['rod', 'jane', 'freddy'] ==--

freddy

--== urlsplit hostname ==--

docs.ansible.com

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/02-07-01$ ssh packt@192.168.0.42
packt@ubuntu1:~$ cat /tmp/ubuntu1_template.out
--== Ansible Jinja2 if statement ==--


--== Ansible Jinja2 if elif statement ==--


--== Ansible Jinja2 if elif else statement ==--

This is good old ubuntu1

--== Ansible Jinja2 if variable is defined ( where variable is not defined ) ==--

example_variable is not defined

--== Ansible Jinja2 if varible is defined ( where variable is defined ) ==--

example_variable is defined

--== Ansible Jinja2 for statement ==--

IP Address entry 1 = 192.168.1.16
IP Address entry 2 = 192.168.0.42


## Ansible Playbooks, Creating and Executing

- A use case example of using Ansible Playbooks
- Installing Nginx Web Server on CentOS & Ubuntu
- Using Ansible o standardize the configuration across both platforms
- Using Ansible to fix any issues that arise owing to differences in the different operating systems
- Templating a website
- Using Ansible facts to customize our template page

# Ansible link on Nginx differences between CentOS & Ubuntu
https://stackoverflow.com/questions/17413526/nginx-missing-sites-available-directory

ansible all -i packt@192.168.0.47,packt@192.168.0.43, -m setup -a 'filter=ansible_distribution'

# nginx_playbook3.yml output

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/02-08-01$ ansible-playbook nginx_playbook3.yml 

PLAY [centos] ********************************************************************************************************

TASK [Gathering Facts] ***********************************************************************************************
ok: [centos2]
ok: [centos1]
ok: [centos3]

TASK [Install EPEL] **************************************************************************************************
ok: [centos2]
ok: [centos1]
ok: [centos3]

TASK [Install Nginx] *************************************************************************************************
ok: [centos3]
ok: [centos2]
ok: [centos1]

TASK [Install Patch] *************************************************************************************************
ok: [centos3]
ok: [centos2]
ok: [centos1]

TASK [Patch nginx.conf to include sites-available, disable default server entry] *************************************
ok: [centos2]
changed: [centos3]
changed: [centos1]

PLAY RECAP ***********************************************************************************************************
centos1                    : ok=5    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
centos2                    : ok=5    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
centos3                    : ok=5    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

# nginx_playbook10.yml output

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/02-08-01$ ansible-playbook nginx_playbook10.yml

PLAY [centos3] *******************************************************************************************************

TASK [Gathering Facts] ***********************************************************************************************
ok: [centos3]

TASK [Install EPEL] **************************************************************************************************
ok: [centos3]

TASK [Install Nginx] *************************************************************************************************
ok: [centos3]

TASK [Install Patch] *************************************************************************************************
ok: [centos3]

TASK [Patch nginx.conf to include sites-available, disable default server entry] *************************************
ok: [centos3]

TASK [Create /etc/nginx/sites-available directory if required] *******************************************************
ok: [centos3]

TASK [Create /etc/nginx/sites-enabled directory if required] *********************************************************
ok: [centos3]

TASK [Copy default nginx configuration] ******************************************************************************
ok: [centos3]

TASK [Symbolic link /etc/nginx/sites-available/default to /etc/nginx/sites-enabled/default] **************************
ok: [centos3]

TASK [Create nginx/html directory if required] ***********************************************************************
ok: [centos3]

TASK [Template index.html.j2 to index.html on target] ****************************************************************
changed: [centos3]

TASK [Restart nginx] *************************************************************************************************
changed: [centos3]

TASK [Open CentOS firewall for Nginx] ********************************************************************************
ok: [centos3]

RUNNING HANDLER [Check HTTP Service] *********************************************************************************
ok: [centos3]

PLAY RECAP ***********************************************************************************************************
centos3                    : ok=14   changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 


## Section 3 - 1. Ansible Playbooks, Advanced Topics

- Ansible Playbook modules
- Dynamic inventories
- register and when
- Looping
- Asynchronous and Parellel
- Task delegation
- Magic variables
- Blocks
- Using the Ansible Vault
- Creating custom modules
- Creating plugins

# Ansible playbook modules

- Ansible playbook modules
- set_fact
- pause
- prompt
- wait_for
- assemble
- add_host
- group_by
- fetch

* Ansible playbook modules
# Prior to running wait_for_playbook.yml
# Stop the nginx service on the centos2 vm

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-01-01$ ansible centos -m service -a 'name=nginx state=stopped'
centos2 | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    }, 
    "changed": false, 
    "name": "nginx", 
    "state": "stopped", 
    "status": {
        "ActiveEnterTimestampMonotonic": "0", 
        "ActiveExitTimestampMonotonic": "0", 
        "ActiveState": "inactive", 

# run the playbook

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-01-01$ ansible-playbook wait_for_playbook.yml &  # Press Enter to come out of this ansible-playbook execution

PLAY [centos3] ******************************************************************************************************************

TASK [Gathering Facts] **********************************************************************************************************
ok: [centos3]

TASK [Wait for the webserver to be running on port 80] **************************************************************************

# restart the Nginx service on the centos group 

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-01-01$ ansible centos2 -m service -a 'name=nginx state=started'
centos2 | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    }, 
    "changed": false, 
    "name": "nginx", 
    "state": "started", 
    "status": {
        "ActiveEnterTimestamp": "Sun 2019-11-17 21:35:29 GMT", 
        "ActiveEnterTimestampMonotonic": "25343698897", 
        "ActiveExitTimestampMonotonic": "0", 
        "ActiveState": "active",
        .
        .
        .
        .
        .
        .
        "Type": "forking", 
        "UMask": "0022", 
        "UnitFilePreset": "disabled", 
        "UnitFileState": "disabled", 
        "Wants": "system.slice", 
        "WatchdogTimestampMonotonic": "0", 
        "WatchdogUSec": "0"
    }
}
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-01-01$ ok: [centos3]

PLAY RECAP **********************************************************************************************************************
centos3                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


[1]+  Done                    ansible-playbook wait_for_playbook.yml
# Completed

# You can use 'ansible-doc' to check out it's uses i.e.

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-01-01$ ansible-doc wait_for
> WAIT_FOR    (/usr/lib/python2.7/dist-packages/ansible/modules/utilities/logic/wait_for.py)

        You can wait for a set amount of time `timeout', this is the default if nothing is specified or just `timeout' is specified. This does not produce
        an error. Waiting for a port to become available is useful for when services are not immediately available after their init scripts return which
        is true of certain Java application servers. It is also useful when starting guests with the [virt] module and needing to pause until they are
        ready. This module can also be used to wait for a regex match a string to be present in a file. In Ansible 1.6 and later, this module can also be
        used to wait for a file to be available or absent on the filesystem. In Ansible 1.8 and later, this module can also be used to wait for active
        connections to be closed before continuing, useful if a node is being rotated out of a load balancer pool. For Windows targets, use the
        [win_wait_for] module instead.

  * This module is maintained by The Ansible Core Team

## *** Should have done this a while ago ***

## Add these to your ~/.bashrc file

# Q Alias commands
alias ..="cd .."
alias qh="cd /home/robq/"

alias gs="git status"
alias gpus="git push"
alias gpo="git push origin $1"
alias ga.="git add ."
alias gaa="git add --all"
alias gcm="git commit -m $1"
alias gcam="git commit -am $1"
alias gdf="git diff $1"
alias gpul="git pull"
alias grh="git reset --hard $1"
alias gl="git log"
alias glg='git log --pretty=format:"%h %s" --graph'
alias gc="git checkout $1"

alias a-g="ansible-galaxy $1"
alias a-p="ansible-playbook $1"
alias a-v="ansible-vault $1"
alias a="ansible"

# More to follow.....

## Section 3 - 2. Dynamic Inventories

- Dynamic inventories
- The requirements of dynamic inventories
- How to create a dynamic inventory with minimal scripting
- How to interrogate a dynamic inventory
- The use of the Ansible development tools for testing dynamic inventories
- Performance enhancements through the use of _meta
- The use of the Ansible Python framework for dynamic inventories

 * Dynamic Inventory Requirements
- Needs to be an executable file, can be written in any language, proving
  that it can be executed from the command line.
- Accepts the command line options of --list, and --host hostname.
- Returns JSON encoded dictionary of inventory content when used with
  --list
- Returns a basic JSON encoded dictionary structure for --host <hostname>

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-02-01$ ./inventory.py --list
{
    "centos2": {
        "hosts": [
            "192.168.0.46"
        ], 
        "vars": {
            "ansible_user": "root"
        }
    }, 
    "control": {
        "hosts": [
            "robq-VirtualBox"
        ]
    }, 
    "linux": {
        "children": [
            "centos", 
            "ubuntu"
        ]
    }, 
    "ubuntu2": {
        "hosts": [
            "192.168.0.43"
        ], 
        "vars": {
            "ansible_user": "packt"
        }
    }
}
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-02-01$ ansible all -i inventory.py --list-hosts
  hosts (3):
    robq-VirtualBox
    192.168.0.43
    192.168.0.46
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-02-01$ ansible all -i inventory.py -m ping -o
robq-VirtualBox | SUCCESS => {"ansible_facts": {"discovered_interpreter_python": "/usr/bin/python"}, "changed": false, "ping": "pong", "warnings": ["Platform linux on host robq-VirtualBox is using the discovered Python interpreter at /usr/bin/python, but future installation of another Python interpreter could change this. See https://docs.ansible.com/ansible/2.8/reference_appendices/interpreter_discovery.html for more information."]}
192.168.0.43 | SUCCESS => {"ansible_facts": {"discovered_interpreter_python": "/usr/bin/python"}, "changed": false, "deprecations": [{"msg": "Distribution Ubuntu 16.04 on host 192.168.0.43 should use /usr/bin/python3, but is using /usr/bin/python for backward compatibility with prior Ansible releases. A future Ansible release will default to using the discovered platform python for this host. See https://docs.ansible.com/ansible/2.8/reference_appendices/interpreter_discovery.html for more information", "version": "2.12"}], "ping": "pong"}
192.168.0.46 | SUCCESS => {"ansible_facts": {"discovered_interpreter_python": "/usr/bin/python"}, "changed": false, "ping": "pong"}
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-02-01$

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-02-01$ ansible all -i inventory.py --list-hosts
  hosts (3):
    robq-VirtualBox
    192.168.0.43
    192.168.0.46
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-02-01$ ./inventory.py --host centos2
{}
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-02-01$ cat /var/tmp/ansible_dynamic_inventory.log 
2020-01-06 22:06:51,613 INFO list executed
2020-01-06 22:06:51,662 INFO host executed for 192.168.0.43
2020-01-06 22:06:51,710 INFO host executed for robq-VirtualBox
2020-01-06 22:06:51,755 INFO host executed for 192.168.0.46
2020-01-06 22:07:10,293 INFO host executed for centos2
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-02-01$ time ansible all -i inventory.py --list-hosts
  hosts (3):
    robq-VirtualBox
    192.168.0.43
    192.168.0.46

real	0m1.106s
user	0m0.699s
sys	0m0.213s
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-02-01$

# Running inventory3 with 1000 fake hosts

ansible all -i inventory3.py --list-hosts
tail -f /var/tmp/ansible_dynamic_inventory.log &
ansible all -i inventory3.py --list-hosts
jobs
[1]+  Running                 tail -f /var/tmp/ansible_dynamic_inventory.log &
kill %1

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-02-01$ time ansible all -i inventory3.py --list-hosts
real	0m56.548s
user	0m42.681s
sys	0m12.699s

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-02-01$ time ansible all -i inventory4.py --list-hosts
real	0m0.954s
user	0m0.803s
sys	0m0.150s


## Section 3 - 3. Register and When

- register and when
- How to register output with the register directive
- How to use registered output
- How to work around differences with registered output
- Filters, that relate to registered content

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-03-01$ ansible all -a 'hostname -s' -o
robq-VirtualBox | CHANGED | rc=0 | (stdout) robq-VirtualBox
ubuntu2 | CHANGED | rc=0 | (stdout) ubuntu2
centos2 | CHANGED | rc=0 | (stdout) centos2
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-03-01$ 

# Run the below before running the register_playbook6.yml
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-03-01$ ansible linux -m setup -a filter='ansible_distribution*'
ubuntu2 | SUCCESS => {
    "ansible_facts": {
        "ansible_distribution": "Ubuntu", 
        "ansible_distribution_file_parsed": true, 
        "ansible_distribution_file_path": "/etc/os-release", 
        "ansible_distribution_file_variety": "Debian", 
        "ansible_distribution_major_version": "16", 
        "ansible_distribution_release": "xenial", 
        "ansible_distribution_version": "16.04", 
        "discovered_interpreter_python": "/usr/bin/python"
    }, 
    "changed": false
}
centos2 | SUCCESS => {
    "ansible_facts": {
        "ansible_distribution": "CentOS", 
        "ansible_distribution_file_parsed": true, 
        "ansible_distribution_file_path": "/etc/redhat-release", 
        "ansible_distribution_file_variety": "RedHat", 
        "ansible_distribution_major_version": "7", 
        "ansible_distribution_release": "Core", 
        "ansible_distribution_version": "7", 
        "discovered_interpreter_python": "/usr/bin/python"
    }, 
    "changed": false
}

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-03-01$ a-p register_when_playbook1.yml 

PLAY [linux] ************************************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************************
ok: [ubuntu2]
ok: [centos2]

TASK [Exploring register] ***********************************************************************************************************************************************************************
skipping: [ubuntu2]
changed: [centos2]

TASK [Show register] ****************************************************************************************************************************************************************************
ok: [centos2] => {
    "command_register": {
        "changed": true, 
        "cmd": [
            "hostname", 
            "-s"
        ], 
        "delta": "0:00:00.004742", 
        "end": "2019-12-24 16:19:17.566481", 
        "failed": false, 
        "rc": 0, 
        "start": "2019-12-24 16:19:17.561739", 
        "stderr": "", 
        "stderr_lines": [], 
        "stdout": "centos2", 
        "stdout_lines": [
            "centos2"
        ]
    }
}
ok: [ubuntu2] => {
    "command_register": {
        "changed": false, 
        "skip_reason": "Conditional result was False", 
        "skipped": true
    }
}

PLAY RECAP **************************************************************************************************************************************************************************************
centos2                    : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ubuntu2                    : ok=2    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-03-01$ 

## Section 3 - 4. Looping

- Looping
- with_items
- with_dict
- with_subelements
- with_together
- with_sequence .... many other loops ... with_random_choice
- until

# userplaybook5.yml

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-04-01$ a-p user_playbook5.yml 

PLAY [linux] ************************************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************************
^Lok: [ubuntu2]
ok: [centos2]

TASK [Creating user] ****************************************************************************************************************************************************************************
changed: [ubuntu2] => (item=jimmy2b)
changed: [centos2] => (item=jimmy2b)
changed: [ubuntu2] => (item=harry)
changed: [centos2] => (item=harry)
changed: [ubuntu2] => (item=lilly)
changed: [centos2] => (item=lilly)
changed: [ubuntu2] => (item=tarquin)
changed: [centos2] => (item=tarquin)

PLAY RECAP **************************************************************************************************************************************************************************************
centos2                    : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ubuntu2                    : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-04-01$ ssh packt@192.168.0.43 tail -5 /etc/passwd
sshd:x:108:65534::/var/run/sshd:/usr/sbin/nologin
jimmy2b:x:1001:1001::/home/jimmy2b:
harry:x:1002:1002::/home/harry:
lilly:x:1003:1003::/home/lilly:
tarquin:x:1004:1004::/home/tarquin:
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-04-01$ ssh packt@192.168.0.46 tail -5 /etc/passwd
nginx:x:997:995:Nginx web server:/var/lib/nginx:/sbin/nologin
jimmy2b:x:1001:1001::/home/jimmy2b:/bin/bash
harry:x:1002:1002::/home/harry:/bin/bash
lilly:x:1003:1003::/home/lilly:/bin/bash
tarquin:x:1004:1004::/home/tarquin:/bin/bash
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-04-01$ a-p user_playbook6.yml 

PLAY [linux] ************************************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************************
ok: [ubuntu2]
ok: [centos2]

TASK [Creating user] ****************************************************************************************************************************************************************************
changed: [ubuntu2] => (item=jimmy2b)
changed: [centos2] => (item=jimmy2b)
changed: [ubuntu2] => (item=harry)
changed: [centos2] => (item=harry)
changed: [ubuntu2] => (item=lilly)
changed: [centos2] => (item=lilly)
changed: [ubuntu2] => (item=tarquin)
changed: [centos2] => (item=tarquin)

PLAY RECAP **************************************************************************************************************************************************************************************
centos2                    : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ubuntu2                    : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-04-01$ ssh packt@192.168.0.46 tail -5 /etc/passwd
postfix:x:89:89::/var/spool/postfix:/sbin/nologin
chrony:x:998:996::/var/lib/chrony:/sbin/nologin
sshd:x:74:74:Privilege-separated SSH:/var/empty/sshd:/sbin/nologin
packt:x:1000:1000:packt:/home/packt:/bin/bash
nginx:x:997:995:Nginx web server:/var/lib/nginx:/sbin/nologin
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-04-01$ ssh packt@192.168.0.43 tail -5 /etc/passwd
_apt:x:105:65534::/nonexistent:/bin/false
messagebus:x:106:110::/var/run/dbus:/bin/false
uuidd:x:107:111::/run/uuidd:/bin/false
packt:x:1000:1000:packt,,,:/home/packt:/bin/bash
sshd:x:108:65534::/var/run/sshd:/usr/sbin/nologin
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-04-01$ 

# userplaybook7.yml

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-04-01$ a-p user_playbook7.yml 

PLAY [linux] ************************************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************************
ok: [ubuntu2]
ok: [centos2]

TASK [Creating user] ****************************************************************************************************************************************************************************
changed: [ubuntu2] => (item={'value': {u'full_name': u'Lilly Besi'}, 'key': u'lilly'})
changed: [centos2] => (item={'value': {u'full_name': u'Lilly Besi'}, 'key': u'lilly'})
changed: [ubuntu2] => (item={'value': {u'full_name': u'Harry Besi'}, 'key': u'harry'})
changed: [centos2] => (item={'value': {u'full_name': u'Harry Besi'}, 'key': u'harry'})
changed: [ubuntu2] => (item={'value': {u'full_name': u'Jimmy 2 bananas'}, 'key': u'jimmy2b'})
changed: [centos2] => (item={'value': {u'full_name': u'Jimmy 2 bananas'}, 'key': u'jimmy2b'})
changed: [ubuntu2] => (item={'value': {u'full_name': u'Tarquin Farquhar'}, 'key': u'tarquin'})
changed: [centos2] => (item={'value': {u'full_name': u'Tarquin Farquhar'}, 'key': u'tarquin'})

PLAY RECAP **************************************************************************************************************************************************************************************
centos2                    : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ubuntu2                    : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-04-01$ ssh packt@192.168.0.46 tail -5 /etc/passwd
nginx:x:997:995:Nginx web server:/var/lib/nginx:/sbin/nologin
lilly:x:1001:1001:Lilly Besi:/home/lilly:/bin/bash
harry:x:1002:1002:Harry Besi:/home/harry:/bin/bash
jimmy2b:x:1003:1003:Jimmy 2 bananas:/home/jimmy2b:/bin/bash
tarquin:x:1004:1004:Tarquin Farquhar:/home/tarquin:/bin/bash
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-04-01$

# Output from CentOS Box for playbook11 & playbook12

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-04-01$ ssh packt@192.168.0.46 -l root tree /home/
/home/
├── alison
│   ├── coffee
│   ├── documents
│   ├── movies
│   └── photos
├── anna
│   ├── documents
│   ├── japanese
│   ├── movies
│   └── photos
├── harry
│   ├── documents
│   ├── movies
│   ├── photos
│   └── psychology
├── jimmy2b
│   ├── documents
│   ├── movies
│   ├── photos
│   └── tech
├── jimmy2bb
├── lilly
│   ├── dancing
│   ├── documents
│   ├── movies
│   └── photos
├── lilz
├── packt
│   └── ansible
│       └── facts.d
│           ├── getdate1.fact
│           └── getdate2.fact
├── sarah
│   ├── documents
│   ├── movies
│   ├── music
│   └── photos
└── tarquin
    ├── documents
    ├── movies
    ├── photos
    └── smiling

40 directories, 2 files
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-04-01$


robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-04-01$ a-p user_playbook13.yml 

PLAY [linux] ************************************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************************
ok: [ubuntu2]
ok: [centos2]

TASK [Creating user] ****************************************************************************************************************************************************************************
ok: [ubuntu2] => (item={'value': {u'full_name': u'Lilly R'}, 'key': u'lilly'})
ok: [centos2] => (item={'value': {u'full_name': u'Lilly R'}, 'key': u'lilly'})

TASK [Create authorized key] ********************************************************************************************************************************************************************
changed: [ubuntu2] => (item=ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDpHPZxDE8G0J5Z4Zg8+ZPqN9V024A25OAlud3yefHnZKXDvkvlsu2N1ODCm1Vw3MCfNCqxEimK4hYvayNffCcdqdL6KIRsRS8Z7LyHhplz/joH7YIXRc0K8IH2LymRon0bflv3WViOSUHUW9jRgIZmu7UTS4HHfe9gXfjwEbtIXmKkut7MHDenBsoe9iW40Y58pxlm/ZNI+KviW+espmMmydDKbpGCNt2g9S0JDJuU9euweshIm5YGtgYpFKuJdSjbw8sP0mb8Zi9G2Nre96Lw6k6I4k/pfTVLARTdFbO8K9yrBtbuNOT+BdjRhAF/yQ/w894Nt7WhdVWIWBjn8WVHyNSBxeuDWoOUzzP/Y+ygS/UNWSe41rzVOBf8cPWbIgGG4g5NZyh2K//9hRv3vyBl3RcrzgYYHhb/roKTzi1qhaEcxB7AFhDOgmb8WHrdDmje+A4FUOSeBeY3im+i8t9yJ8wXORXmq86ciWll7C2a37xjiqNVyvYVjq2P0FGLBah0w5QP/5nC5akuCSLgUuhtmKMuqhRm4vmcImRuQIPTSo8a5LMmxRrLTmvkLNy9NFcMTbjFHkawvkgzmrMvLJYWINFK7V2ChEuMIv5NuaALyJpaAfRf/b00uHgnfQBZCSGzF185/3m8mr/9MMxG2Rm7E+ftoqbr0a6ym9RnjchB1w== packt@gmail.com)
changed: [centos2] => (item=ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDpHPZxDE8G0J5Z4Zg8+ZPqN9V024A25OAlud3yefHnZKXDvkvlsu2N1ODCm1Vw3MCfNCqxEimK4hYvayNffCcdqdL6KIRsRS8Z7LyHhplz/joH7YIXRc0K8IH2LymRon0bflv3WViOSUHUW9jRgIZmu7UTS4HHfe9gXfjwEbtIXmKkut7MHDenBsoe9iW40Y58pxlm/ZNI+KviW+espmMmydDKbpGCNt2g9S0JDJuU9euweshIm5YGtgYpFKuJdSjbw8sP0mb8Zi9G2Nre96Lw6k6I4k/pfTVLARTdFbO8K9yrBtbuNOT+BdjRhAF/yQ/w894Nt7WhdVWIWBjn8WVHyNSBxeuDWoOUzzP/Y+ygS/UNWSe41rzVOBf8cPWbIgGG4g5NZyh2K//9hRv3vyBl3RcrzgYYHhb/roKTzi1qhaEcxB7AFhDOgmb8WHrdDmje+A4FUOSeBeY3im+i8t9yJ8wXORXmq86ciWll7C2a37xjiqNVyvYVjq2P0FGLBah0w5QP/5nC5akuCSLgUuhtmKMuqhRm4vmcImRuQIPTSo8a5LMmxRrLTmvkLNy9NFcMTbjFHkawvkgzmrMvLJYWINFK7V2ChEuMIv5NuaALyJpaAfRf/b00uHgnfQBZCSGzF185/3m8mr/9MMxG2Rm7E+ftoqbr0a6ym9RnjchB1w== packt@gmail.com)

PLAY RECAP **************************************************************************************************************************************************************************************
centos2                    : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ubuntu2                    : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-04-01$ 

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-04-01$ a-p ssh_key_playbook14.yml 

PLAY [linux] ************************************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************************
ok: [ubuntu2]
ok: [centos2]

TASK [Creating user] ****************************************************************************************************************************************************************************
ok: [ubuntu2] => (item={'value': {u'full_name': u'Lilly R'}, 'key': u'lilly'})
ok: [centos2] => (item={'value': {u'full_name': u'Lilly R'}, 'key': u'lilly'})

TASK [Create authorized key] ********************************************************************************************************************************************************************
ok: [ubuntu2] => (item=ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDpHPZxDE8G0J5Z4Zg8+ZPqN9V024A25OAlud3yefHnZKXDvkvlsu2N1ODCm1Vw3MCfNCqxEimK4hYvayNffCcdqdL6KIRsRS8Z7LyHhplz/joH7YIXRc0K8IH2LymRon0bflv3WViOSUHUW9jRgIZmu7UTS4HHfe9gXfjwEbtIXmKkut7MHDenBsoe9iW40Y58pxlm/ZNI+KviW+espmMmydDKbpGCNt2g9S0JDJuU9euweshIm5YGtgYpFKuJdSjbw8sP0mb8Zi9G2Nre96Lw6k6I4k/pfTVLARTdFbO8K9yrBtbuNOT+BdjRhAF/yQ/w894Nt7WhdVWIWBjn8WVHyNSBxeuDWoOUzzP/Y+ygS/UNWSe41rzVOBf8cPWbIgGG4g5NZyh2K//9hRv3vyBl3RcrzgYYHhb/roKTzi1qhaEcxB7AFhDOgmb8WHrdDmje+A4FUOSeBeY3im+i8t9yJ8wXORXmq86ciWll7C2a37xjiqNVyvYVjq2P0FGLBah0w5QP/5nC5akuCSLgUuhtmKMuqhRm4vmcImRuQIPTSo8a5LMmxRrLTmvkLNy9NFcMTbjFHkawvkgzmrMvLJYWINFK7V2ChEuMIv5NuaALyJpaAfRf/b00uHgnfQBZCSGzF185/3m8mr/9MMxG2Rm7E+ftoqbr0a6ym9RnjchB1w== robq71@gmail.com)
ok: [centos2] => (item=ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDpHPZxDE8G0J5Z4Zg8+ZPqN9V024A25OAlud3yefHnZKXDvkvlsu2N1ODCm1Vw3MCfNCqxEimK4hYvayNffCcdqdL6KIRsRS8Z7LyHhplz/joH7YIXRc0K8IH2LymRon0bflv3WViOSUHUW9jRgIZmu7UTS4HHfe9gXfjwEbtIXmKkut7MHDenBsoe9iW40Y58pxlm/ZNI+KviW+espmMmydDKbpGCNt2g9S0JDJuU9euweshIm5YGtgYpFKuJdSjbw8sP0mb8Zi9G2Nre96Lw6k6I4k/pfTVLARTdFbO8K9yrBtbuNOT+BdjRhAF/yQ/w894Nt7WhdVWIWBjn8WVHyNSBxeuDWoOUzzP/Y+ygS/UNWSe41rzVOBf8cPWbIgGG4g5NZyh2K//9hRv3vyBl3RcrzgYYHhb/roKTzi1qhaEcxB7AFhDOgmb8WHrdDmje+A4FUOSeBeY3im+i8t9yJ8wXORXmq86ciWll7C2a37xjiqNVyvYVjq2P0FGLBah0w5QP/5nC5akuCSLgUuhtmKMuqhRm4vmcImRuQIPTSo8a5LMmxRrLTmvkLNy9NFcMTbjFHkawvkgzmrMvLJYWINFK7V2ChEuMIv5NuaALyJpaAfRf/b00uHgnfQBZCSGzF185/3m8mr/9MMxG2Rm7E+ftoqbr0a6ym9RnjchB1w== robq71@gmail.com)
ok: [ubuntu2] => (item=ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDVuW/BVADBwOV/IkWgh52GD6muOEKKr5DcjS8LHcA9fw+d4yQY/oE65XJs2Oblrw5+7/kKSWj9g+JTxuAbm1PXhoPwKVGRRmlSbkoz0XGVZyaXv16Z4GdbOlbF/2zoyg9++SMeZ1y2cZrFF45sO+KZvr3V+z1cQJLyABtR+LaYQyVQ5DfC3BNvGuPL1MqMFFvHCw6C760+4VEcNek1t7GqJRS1nO5aLT5Hso1JAn4A8FjOxZDAS9FxafpBSKMDAAUQH6lu8ZtlUUwpXo4LPaTltVvTIZA4pAoN7uHFTOIlFC7zxB/vaFavNkrGEe4StVmCLgga3kYYxIFExx3tFqcx packt@ubuntu-c)
ok: [centos2] => (item=ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDVuW/BVADBwOV/IkWgh52GD6muOEKKr5DcjS8LHcA9fw+d4yQY/oE65XJs2Oblrw5+7/kKSWj9g+JTxuAbm1PXhoPwKVGRRmlSbkoz0XGVZyaXv16Z4GdbOlbF/2zoyg9++SMeZ1y2cZrFF45sO+KZvr3V+z1cQJLyABtR+LaYQyVQ5DfC3BNvGuPL1MqMFFvHCw6C760+4VEcNek1t7GqJRS1nO5aLT5Hso1JAn4A8FjOxZDAS9FxafpBSKMDAAUQH6lu8ZtlUUwpXo4LPaTltVvTIZA4pAoN7uHFTOIlFC7zxB/vaFavNkrGEe4StVmCLgga3kYYxIFExx3tFqcx packt@ubuntu-c)

PLAY RECAP **************************************************************************************************************************************************************************************
centos2                    : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ubuntu2                    : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-04-01$ ssh packt@192.168.0.46 cat /home/lilly/.ssh/authorized_keys
cat: /home/lilly/.ssh/authorized_keys: Permission denied
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-04-01$ ssh packt@192.168.0.46 -l root cat /home/lilly/.ssh/authorized_keys
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDpHPZxDE8G0J5Z4Zg8+ZPqN9V024A25OAlud3yefHnZKXDvkvlsu2N1ODCm1Vw3MCfNCqxEimK4hYvayNffCcdqdL6KIRsRS8Z7LyHhplz/joH7YIXRc0K8IH2LymRon0bflv3WViOSUHUW9jRgIZmu7UTS4HHfe9gXfjwEbtIXmKkut7MHDenBsoe9iW40Y58pxlm/ZNI+KviW+espmMmydDKbpGCNt2g9S0JDJuU9euweshIm5YGtgYpFKuJdSjbw8sP0mb8Zi9G2Nre96Lw6k6I4k/pfTVLARTdFbO8K9yrBtbuNOT+BdjRhAF/yQ/w894Nt7WhdVWIWBjn8WVHyNSBxeuDWoOUzzP/Y+ygS/UNWSe41rzVOBf8cPWbIgGG4g5NZyh2K//9hRv3vyBl3RcrzgYYHhb/roKTzi1qhaEcxB7AFhDOgmb8WHrdDmje+A4FUOSeBeY3im+i8t9yJ8wXORXmq86ciWll7C2a37xjiqNVyvYVjq2P0FGLBah0w5QP/5nC5akuCSLgUuhtmKMuqhRm4vmcImRuQIPTSo8a5LMmxRrLTmvkLNy9NFcMTbjFHkawvkgzmrMvLJYWINFK7V2ChEuMIv5NuaALyJpaAfRf/b00uHgnfQBZCSGzF185/3m8mr/9MMxG2Rm7E+ftoqbr0a6ym9RnjchB1w== packt@gmail.com
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDVuW/BVADBwOV/IkWgh52GD6muOEKKr5DcjS8LHcA9fw+d4yQY/oE65XJs2Oblrw5+7/kKSWj9g+JTxuAbm1PXhoPwKVGRRmlSbkoz0XGVZyaXv16Z4GdbOlbF/2zoyg9++SMeZ1y2cZrFF45sO+KZvr3V+z1cQJLyABtR+LaYQyVQ5DfC3BNvGuPL1MqMFFvHCw6C760+4VEcNek1t7GqJRS1nO5aLT5Hso1JAn4A8FjOxZDAS9FxafpBSKMDAAUQH6lu8ZtlUUwpXo4LPaTltVvTIZA4pAoN7uHFTOIlFC7zxB/vaFavNkrGEe4StVmCLgga3kYYxIFExx3tFqcx packt@ubuntu-c
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-04-01$ 

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-04-01$ gs
On branch master
Your branch is up-to-date with 'origin/master'.

Changes to be committed:
  (use "git reset HEAD <file>..." to unstage)

	new file:   count_directory_sequence_playbook18.yml
	new file:   directory_sequence15.yml
	new file:   directory_sequence16.yml
	new file:   hex_directory_sequence_playbook17.yml
	new file:   random.sh
	new file:   random_choice_playbook19.yml
	new file:   ssh_key_playbook14.yml
	new file:   until_playbook20.yml
	new file:   user_playbook11.yml
	new file:   user_playbook12.yml
	new file:   user_playbook13.yml
	modified:   ../../../installation-and-notes.txt

Changes not staged for commit:
  (use "git add <file>..." to update what will be committed)
  (use "git checkout -- <file>..." to discard changes in working directory)

	modified:   ssh_key_playbook14.yml

Untracked files:
  (use "git add <file>..." to include in what will be committed)

	custom_key
	custom_key.pub

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-04-01$

# Output from directory_sequence15 & 16 : hex_directory_sequence_playbook17 : 
# count_directory_sequence_playbook18 and random_choice_playbook19

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-04-01$ ssh packt@192.168.0.46 -l root tree -a /home/lilly
/home/lilly
├── apple
├── .bash_logout
├── .bash_profile
├── .bashrc
├── count_sequence_1
├── count_sequence_2
├── count_sequence_3
├── count_sequence_4
├── count_sequence_5
├── dancing
├── documents
├── hex_sequence_0
├── hex_sequence_1
├── hex_sequence_10
├── hex_sequence_2
├── hex_sequence_3
├── hex_sequence_4
├── hex_sequence_5
├── hex_sequence_6
├── hex_sequence_7
├── hex_sequence_8
├── hex_sequence_9
├── hex_sequence_a
├── hex_sequence_b
├── hex_sequence_c
├── hex_sequence_d
├── hex_sequence_e
├── hex_sequence_f
├── microsoft
├── movies
├── photos
├── sequence_0
├── sequence_10
├── sequence_100
├── sequence_20
├── sequence_30
├── sequence_40
├── sequence_50
├── sequence_60
├── sequence_70
├── sequence_80
├── sequence_90
└── .ssh
    └── authorized_keys

40 directories, 4 files
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-04-01$ 

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-04-01$ a-p until_playbook20.yml 

PLAY [linux] ************************************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************************
ok: [ubuntu2]
ok: [centos2]

TASK [Run a script until we hit 10] *************************************************************************************************************************************************************
FAILED - RETRYING: Run a script until we hit 10 (100 retries left).
...........
FAILED - RETRYING: Run a script until we hit 10 (96 retries left).
FAILED - RETRYING: Run a script until we hit 10 (96 retries left).
FAILED - RETRYING: Run a script until we hit 10 (95 retries left).
FAILED - RETRYING: Run a script until we hit 10 (95 retries left).
FAILED - RETRYING: Run a script until we hit 10 (94 retries left).
............
changed: [ubuntu2]
FAILED - RETRYING: Run a script until we hit 10 (88 retries left).
FAILED - RETRYING: Run a script until we hit 10 (87 retries left).
FAILED - RETRYING: Run a script until we hit 10 (86 retries left).
FAILED - RETRYING: Run a script until we hit 10 (85 retries left).
changed: [centos2]

PLAY RECAP **************************************************************************************************************************************************************************************
centos2                    : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ubuntu2                    : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-04-01$

## Section 3 - 5. Asynchronous and Parallel

- Asynchronous and Parallel
- Playbook performance and bottlenecks
- Polling
- Asynchronous job identifiers
- Asynchronous status handling

# Asynchronous output for slow_playbook3 & 4 - s_pb4 poll set to 0 and Task2 set to /bin/sleep 30

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-05-01$ time a-p slow_playbook3.yml 

PLAY [linux] ************************************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************************
ok: [ubuntu2]
ok: [centos2]

TASK [Task 1] ***********************************************************************************************************************************************************************************
skipping: [ubuntu2]
changed: [centos2]

TASK [Task 2] ***********************************************************************************************************************************************************************************
skipping: [centos2]
changed: [ubuntu2]

PLAY RECAP **************************************************************************************************************************************************************************************
centos2                    : ok=2    changed=1    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   
ubuntu2                    : ok=2    changed=1    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   


real	0m17.703s
user	0m4.929s
sys	0m1.038s
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-05-01$ time a-p slow_playbook4.yml 

PLAY [linux] ************************************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************************
ok: [ubuntu2]
ok: [centos2]

TASK [Task 1] ***********************************************************************************************************************************************************************************
skipping: [ubuntu2]
changed: [centos2]

TASK [Task 2] ***********************************************************************************************************************************************************************************
skipping: [centos2]
changed: [ubuntu2]

PLAY RECAP **************************************************************************************************************************************************************************************
centos2                    : ok=2    changed=1    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   
ubuntu2                    : ok=2    changed=1    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   


real	0m7.267s
user	0m4.472s
sys	0m0.949s
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-05-01$ ps -ef | grep ansible
robq      2797  2764  0 Jan09 ?        00:00:30 /usr/share/code/code /home/robq/.vscode/extensions/vscoss.vscode-ansible-0.5.2/node_modules/vscode-languageclient/lib/utils/electronForkStart /home/robq/.vscode/extensions/vscoss.vscode-ansible-0.5.2/out/server/server.js --node-ipc --clientProcessId=2764
robq     19292     1  0 15:38 ?        00:00:00 ssh: /home/robq/.ansible/cp/de89ebd5a7 [mux]
robq     19303     1  0 15:38 ?        00:00:00 ssh: /home/robq/.ansible/cp/456c47d43e [mux]
robq     19338 13507  0 15:38 pts/0    00:00:00 grep --color=auto ansible

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-05-01$ a-p slow_playbook7.yml 

PLAY [linux] ************************************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************************
ok: [ubuntu2]
ok: [centos2]

TASK [Task 1] ***********************************************************************************************************************************************************************************
skipping: [ubuntu2]
changed: [centos2]

TASK [Task 2] ***********************************************************************************************************************************************************************************
skipping: [centos2]
changed: [ubuntu2]

TASK [Capture Job IDs] **************************************************************************************************************************************************************************
ok: [centos2] => (item={'failed': False, u'finished': 0, u'results_file': u'/root/.ansible_async/94629011307.19245', u'ansible_job_id': u'94629011307.19245', u'started': 1, 'changed': True})
ok: [centos2] => (item={'skipped': True, 'changed': False, 'skip_reason': u'Conditional result was False'})
ok: [ubuntu2] => (item={'skipped': True, 'changed': False, 'skip_reason': u'Conditional result was False'})
ok: [ubuntu2] => (item={'failed': False, u'finished': 0, u'results_file': u'/root/.ansible_async/99189408348.14634', u'ansible_job_id': u'99189408348.14634', u'started': 1, 'changed': True})

TASK [Show Job IDs] *****************************************************************************************************************************************************************************
ok: [centos2] => {
    "jobids": [
        "94629011307.19245"
    ]
}
ok: [ubuntu2] => {
    "jobids": [
        "99189408348.14634"
    ]
}

TASK [Wait for Job IDs] *************************************************************************************************************************************************************************
FAILED - RETRYING: Wait for Job IDs (30 retries left).
FAILED - RETRYING: Wait for Job IDs (30 retries left).
changed: [ubuntu2] => (item=99189408348.14634)
changed: [centos2] => (item=94629011307.19245)

PLAY RECAP **************************************************************************************************************************************************************************************
centos2                    : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   
ubuntu2                    : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-05-01$ 

## Section 3 - 6. Task Delegation

- Task delegation
- How we can delegate specific tasks, for execution on specific targets

ssh packt@192.168.0.40 # dnsmasq
sudo su
apt-get update
apt-get install python-pip
pip install hostsman
which hostsman

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-06-01$ a-p dynamic_dns_playbook2.yml 

PLAY [linux] ************************************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************************
ok: [ubuntu2]
ok: [centos2]

TASK [Add dynamic dns rule] *********************************************************************************************************************************************************************
changed: [centos2 -> None]
changed: [ubuntu2 -> None]

TASK [Reload dnsmasq] ***************************************************************************************************************************************************************************
changed: [ubuntu2 -> None]
changed: [centos2 -> None]

PLAY RECAP **************************************************************************************************************************************************************************************
centos2                    : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ubuntu2                    : ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-06-01$ ssh packt@192.168.0.40 cat /etc/hosts
127.0.0.1	localhost
192.168.0.40	dnsmasq
192.168.0.48	robq-VirtualBox
192.168.0.42	ubuntu1
192.168.0.43	ubuntu2
192.168.0.44	ubuntu3
192.168.0.45	centos1
192.168.0.46	centos2
192.168.0.47	centos3

# The following lines are desirable for IPv6 capable hosts
::1	localhost ip6-localhost ip6-loopback
ff02::1	ip6-allnodes
ff02::2	ip6-allrouters
10.0.2.15	dynamic_ubuntu2
10.0.4.15	dynamic_centos2
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-06-01$ a-p dynamic_dns_playbook4.yml 

PLAY [linux] ************************************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************************
ok: [ubuntu2]
ok: [centos2]

TASK [Add dynamic dns rule] *********************************************************************************************************************************************************************
changed: [centos2 -> None]
changed: [ubuntu2 -> None]

TASK [Reload dnsmasq] ***************************************************************************************************************************************************************************
changed: [centos2 -> None]

TASK [Check DNS entries for all hosts] **********************************************************************************************************************************************************
fatal: [centos2]: FAILED! => {"msg": "An unhandled exception occurred while running the lookup plugin 'dig'. Error was a <class 'ansible.errors.AnsibleError'>, original message: The dig lookup requires the python 'dnspython' library and it is not installed"}
fatal: [ubuntu2]: FAILED! => {"msg": "An unhandled exception occurred while running the lookup plugin 'dig'. Error was a <class 'ansible.errors.AnsibleError'>, original message: The dig lookup requires the python 'dnspython' library and it is not installed"}

PLAY RECAP **************************************************************************************************************************************************************************************
centos2                    : ok=3    changed=2    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0   
ubuntu2                    : ok=2    changed=1    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0   

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-06-01$ pip install dnspython #did'nt work for me :-(

# Installed dnspython manually via http://www.dnspython.org/kits/1.16.0/
# then ran 
python setup.py install

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-06-01$ a-p dynamic_dns_playbook4.yml 

PLAY [linux] ************************************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************************
ok: [ubuntu2]
ok: [centos2]

TASK [Add dynamic dns rule] *********************************************************************************************************************************************************************
changed: [centos2 -> None]
changed: [ubuntu2 -> None]

TASK [Reload dnsmasq] ***************************************************************************************************************************************************************************
changed: [centos2 -> None]

TASK [Check DNS entries for all hosts] **********************************************************************************************************************************************************
fatal: [centos2]: FAILED! => {"msg": "An unhandled exception occurred while running the lookup plugin 'dig'. Error was a <class 'ansible.errors.AnsibleError'>, original message: dns.resolver unhandled exception All nameservers failed to answer the query dynamic_centos2. IN A: Server 127.0.0.53 UDP port 53 answered SERVFAIL"}
fatal: [ubuntu2]: FAILED! => {"msg": "An unhandled exception occurred while running the lookup plugin 'dig'. Error was a <class 'ansible.errors.AnsibleError'>, original message: dns.resolver unhandled exception All nameservers failed to answer the query dynamic_centos2. IN A: Server 127.0.0.53 UDP port 53 answered SERVFAIL"}

PLAY RECAP **************************************************************************************************************************************************************************************
centos2                    : ok=3    changed=2    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0   
ubuntu2                    : ok=2    changed=1    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0   

# From the start the hostname has never been able to resolve for me :-(
# I will need to fix ;-)

# Lolz - Partially fixed using local IP's 10.0.

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-06-01$ a-p dynamic_dns_playbook4.yml 

PLAY [linux] ************************************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************************
ok: [ubuntu2]
ok: [centos2]

TASK [Add dynamic dns rule] *********************************************************************************************************************************************************************
changed: [ubuntu2 -> None]
changed: [centos2 -> None]

TASK [Reload dnsmasq] ***************************************************************************************************************************************************************************
changed: [centos2 -> None]

TASK [Check DNS entries for all hosts] **********************************************************************************************************************************************************
ok: [centos2] => (item=centos2) => {
    "msg": "The IPv4 address for 10.0.centos2 is NXDOMAIN"
}
ok: [centos2] => (item=ubuntu2) => {
    "msg": "The IPv4 address for 10.0.ubuntu2 is NXDOMAIN"
}
ok: [ubuntu2] => (item=centos2) => {
    "msg": "The IPv4 address for 10.0.centos2 is NXDOMAIN"
}
ok: [ubuntu2] => (item=ubuntu2) => {
    "msg": "The IPv4 address for 10.0.ubuntu2 is NXDOMAIN"
}

PLAY RECAP **************************************************************************************************************************************************************************************
centos2                    : ok=4    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ubuntu2                    : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-06-01$ a-p dynamic_dns_playbook5.yml 

PLAY [linux] ************************************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************************
ok: [ubuntu2]
ok: [centos2]

TASK [Add dynamic dns rule] *********************************************************************************************************************************************************************
changed: [ubuntu2 -> None]
changed: [centos2 -> None]

TASK [Reload dnsmasq] ***************************************************************************************************************************************************************************
changed: [centos2 -> None]

TASK [Check DNS entries for all hosts] **********************************************************************************************************************************************************
ok: [centos2] => (item=centos2) => {
    "msg": "The IPv4 address for dynamic_centos2 is NXDOMAIN"
}
ok: [centos2] => (item=ubuntu2) => {
    "msg": "The IPv4 address for dynamic_ubuntu2 is NXDOMAIN"
}
ok: [ubuntu2] => (item=centos2) => {
    "msg": "The IPv4 address for dynamic_centos2 is NXDOMAIN"
}
ok: [ubuntu2] => (item=ubuntu2) => {
    "msg": "The IPv4 address for dynamic_ubuntu2 is NXDOMAIN"
}

TASK [Remove dynamic dns rule] ******************************************************************************************************************************************************************
changed: [centos2 -> None]
changed: [ubuntu2 -> None]

TASK [Reload dnsmasq] ***************************************************************************************************************************************************************************
changed: [centos2 -> None]

PLAY RECAP **************************************************************************************************************************************************************************************
centos2                    : ok=6    changed=4    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ubuntu2                    : ok=4    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-06-01$ ssh packt@192.168.0.40 cat /etc/hosts
127.0.0.1	localhost
192.168.0.40	dnsmasq
192.168.0.48	robq-VirtualBox
192.168.0.42	ubuntu1
192.168.0.43	ubuntu2
192.168.0.44	ubuntu3
192.168.0.45	centos1
192.168.0.46	centos2
192.168.0.47	centos3

# The following lines are desirable for IPv6 capable hosts
::1	localhost ip6-localhost ip6-loopback
ff02::1	ip6-allnodes
ff02::2	ip6-allrouters
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-06-01$

## Section 3 - 7. Magic Variables

# The dump_vars_playbook.yml when ran will pull variables from all of the hosts including control, 
  using the templates/dump_variables file to format the output into yaml...
# Outputs for all the hosts can be found in the captured_variables folder

## Section 3 - 8. Blocks

- Blocks
- How to group multiple tasks, into a single block
- Rescue
- Always

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-08-01$ a-p blocks_playbook2.yml 

PLAY [linux] ************************************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************************
ok: [ubuntu2]
ok: [centos2]

TASK [Example 1 CentOS only] ********************************************************************************************************************************************************************
skipping: [ubuntu2]
ok: [centos2] => {
    "msg": "Example 1 CentOS only"
}

TASK [Example 2 Ubuntu only] ********************************************************************************************************************************************************************
ok: [ubuntu2] => {
    "msg": "Example 2 Ubuntu only"
}
skipping: [centos2]

TASK [Example 3 with items] *********************************************************************************************************************************************************************
ok: [ubuntu2] => (item=x) => {
    "msg": "Example 3 with items - x"
}
ok: [ubuntu2] => (item=y) => {
    "msg": "Example 3 with items - y"
}
ok: [ubuntu2] => (item=z) => {
    "msg": "Example 3 with items - z"
}
ok: [centos2] => (item=x) => {
    "msg": "Example 3 with items - x"
}
ok: [centos2] => (item=y) => {
    "msg": "Example 3 with items - y"
}
ok: [centos2] => (item=z) => {
    "msg": "Example 3 with items - z"
}

PLAY RECAP **************************************************************************************************************************************************************************************
centos2                    : ok=3    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   
ubuntu2                    : ok=3    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-08-01$ 

## Section 3 - 9. Using the Ansible Vault

- Using the Ansible Vault
- Encrypting / Decrypting Variables
- Encrypting and Decrypting files
- Re-Encrypting data
- Using Multiple Vaults

ansible-vault encrypt_string --ask-vault-pass --name 'ansible_become_pass' '$your_password'
ansible --ask-vault-pass all -m ping -o

# Revision 2
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-09-01$ ansible-vault --ask-vault-pass encrypt external_vault_vars.yml
New Vault password: 
Confirm New Vault password: 
Encryption successful


robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-09-01$ a-p --ask-vault-pass vault_playbook1.yml 
Vault password: 

PLAY [linux] ************************************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************************
ok: [ubuntu2]
ok: [centos2]

TASK [Show external_vault_var] ******************************************************************************************************************************************************************
ok: [ubuntu2] => {
    "external_vault_var": "Example External Vault Var"
}
ok: [centos2] => {
    "external_vault_var": "Example External Vault Var"
}

PLAY RECAP **************************************************************************************************************************************************************************************
centos2                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ubuntu2                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-09-01$ a-p --ask-vault-pass vault_playbook1.yml 
Vault password: 
ERROR! Decryption failed (no vault secrets were found that could decrypt) on /home/robq/mastering-ansible/ansible/playbooks/03-09-01/external_vault_vars.yml

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-09-01$ a-v --ask-vault-pass decrypt external_vault_vars.yml 
Vault password: 
Decryption successful
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-09-01$ cat external_vault_vars.yml 
external_vault_var: Example External Vault Var
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-09-01$ 

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-09-01$ a-v --ask-vault-pass rekey external_vault_vars.yml 
Vault password: 
New Vault password: 
Confirm New Vault password: 
Rekey successful
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-09-01$ a-p --ask-vault-pass vault_playbook1.yml 
Vault password: 

PLAY [linux] ************************************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************************
fatal: [ubuntu2]: FAILED! => {"msg": "Decryption failed (no vault secrets were found that could decrypt)"}
ok: [centos2]

TASK [Show external_vault_var] ******************************************************************************************************************************************************************
ok: [centos2] => {
    "external_vault_var": "Example External Vault Var"
}

PLAY RECAP **************************************************************************************************************************************************************************************
centos2                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ubuntu2                    : ok=0    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0   


robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-09-01$ a ubuntu2 --ask-vault-pass -m debug -a 'var=ansible_become_pass'
Vault password: 
ubuntu2 | SUCCESS => {
    "ansible_become_pass": "password"
}

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-09-01$ head -10 group_vars/ubuntu 
---
ansible_user: packt
ansible_become: true
ansible_become_pass: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          32383761383261363436303839303163326630393631366331326161633739383230333938666337
          6266633931303466373862343862636133393263336664630a633539316433326335313331636534
          34623462653363663633356139643663366539396264333632616435346530633264363332316465
          3665633264343135330a663733396533613238353630623537396430323232343566313161616436
          3863
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-09-01$ echo '$ANSIBLE_VAULT;1.1;AES256
> 32383761383261363436303839303163326630393631366331326161633739383230333938666337
> 6266633931303466373862343862636133393263336664630a633539316433326335313331636534
> 34623462653363663633356139643663366539396264333632616435346530633264363332316465
> 3665633264343135330a663733396533613238353630623537396430323232343566313161616436
> 3863' | ansible-vault decrypt -
Vault password: 
Decryption successful
passwordrobq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-09-01$

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-09-01$ a-p --ask-vault-pass vault_playbook2.yml 
Vault password: 

PLAY [linux] ************************************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************************
ok: [ubuntu2]
ok: [centos2]

TASK [Show external_vault_var] ******************************************************************************************************************************************************************
ok: [ubuntu2] => {
    "external_vault_var": "Example External Vault Var"
}
ok: [centos2] => {
    "external_vault_var": "Example External Vault Var"
}

PLAY RECAP **************************************************************************************************************************************************************************************
centos2                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ubuntu2                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-09-01$ a-v --ask-vault-pass view external_vault_vars.yml 
Vault password: 
external_vault_var: Example External Vault Var

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-09-01$ a-v --vault-id password_file view external_vault_vars.yml 
external_vault_var: Example External Vault Var

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-09-01$ a-v --vault-id @prompt view external_vault_vars.yml 
Vault password (default): 
external_vault_var: Example External Vault Var

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-09-01$ a-v --vault-id @password_file view external_vault_vars.yml 
external_vault_var: Example External Vault Var


robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-09-01$ a-v --vault-id vars@prompt encrypt external_vault_vars.yml 
New vault password (vars): 
Confirm new vault password (vars): 
Encryption successful
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-09-01$ gdf external_vault_vars.yml 
diff --git a/ansible/playbooks/03-09-01/external_vault_vars.yml b/ansible/playbooks/03-09-01/external_vault_vars.yml
index 16c224d..54921e1 100644
--- a/ansible/playbooks/03-09-01/external_vault_vars.yml
+++ b/ansible/playbooks/03-09-01/external_vault_vars.yml
@@ -1,7 +1,7 @@
-$ANSIBLE_VAULT;1.1;AES256
-35313532616631313931373664333239383230366533393863313134303434373531323230636537
-3235653162383261636333633964396566643233653536640a316266646661333966306132626563
-65626363323732326462306639323036343235613136316135373931353166336166343336663436
-6465653330363132350a393834643930623139343961666234623361646535613837333634653133
-30366165306231373962643438333130623366363237356638363266323163326530626561306433
-6131303431396437326534336532333566633333363662376633
+$ANSIBLE_VAULT;1.2;AES256;vars
+30376334653030373561323562363638326336636635336466396133303663626330323637343463
+6665326164643031343666663964356135663166373532320a313735323334643936316630376234
+66383064336634666437393666373136626466646236376230356637333633396337656662373366
+3035656635386537620a396236613233623237643631663364323661313330366132313339636665
+66383033616164376138313633333266616166393937313731393061663835386661323365316234
+3830656664356461343537666539336136326265336637653836
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-09-01$ a-v encrypt_string --vault-id ssh@prompt --name 'ansible_become_pass' 'password'
New vault password (ssh): 
Confirm new vault password (ssh): 
ansible_become_pass: !vault |
          $ANSIBLE_VAULT;1.2;AES256;ssh
          38393466626636663232306566336330373261626363353762623831626566343664326637343165
          6265623061356662656661626661666138313564393634390a323661643166386362663736663635
          34343233313134643163623462343138333833616430316436663439303364363238616439386666
          3331666464376562640a633436343730393233623231386663323633326237303338356535666139
          3861
Encryption successful
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-09-01$ a-p --vault-id vars@prompt --vault-id ssh@prompt vault_playbook3.yml 
Vault password (vars): 
Vault password (ssh): 

PLAY [linux] ************************************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************************
ok: [ubuntu2]
ok: [centos2]

TASK [Show external_vault_var] ******************************************************************************************************************************************************************
ok: [centos2] => {
    "external_vault_var": "Example External Vault Var"
}
ok: [ubuntu2] => {
    "external_vault_var": "Example External Vault Var"
}

PLAY RECAP **************************************************************************************************************************************************************************************
centos2                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ubuntu2                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-09-01$ a-v --vault-id playbook@prompt encrypt vault_playbook4.yml 
New vault password (playbook): 
Confirm new vault password (playbook): 
Encryption successful
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-09-01$ a-p --vault-id vars@prompt --vault-id ssh@prompt --vault-id playbook@prompt vault_playbook4.yml 
Vault password (vars): 
Vault password (ssh): 
Vault password (playbook): 

PLAY [linux] ************************************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************************
ok: [ubuntu2]
ok: [centos2]

TASK [Show external_vault_var] ******************************************************************************************************************************************************************
ok: [centos2] => {
    "external_vault_var": "Example External Vault Var"
}
ok: [ubuntu2] => {
    "external_vault_var": "Example External Vault Var"
}

PLAY RECAP **************************************************************************************************************************************************************************************
centos2                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ubuntu2                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

## Section 3 - 10. Creating Custom Modules

- Creating custom modules
- Using the Ansible development tools, to test modules
- Understand the module requirements for input and output
- Create a basic module using shell scripting
- Transition our shell scripted module to the Ansible module Python framework

qh # cd ~/
mkdir src
cd src
git clone https://github.com/ansible/ansible.git
cd ..
src/ansible/hacking/test-module -m src/ansible/lib/ansible/modules/commands/command.py -a hostname
* including generated source, if any, saving to: /home/robq/.ansible_module_generated
* ansiballz module detected; extracted module source to: /home/robq/debug_dir
***********************************
RAW OUTPUT
WARNING: Unknown debug command.  Doing nothing.


***********************************
INVALID OUTPUT FORMAT
WARNING: Unknown debug command.  Doing nothing.

Traceback (most recent call last):
  File "src/ansible/hacking/test-module", line 238, in runtest
    results = json.loads(out)
  File "/usr/lib/python2.7/json/__init__.py", line 339, in loads
    return _default_decoder.decode(s)
  File "/usr/lib/python2.7/json/decoder.py", line 364, in decode
    obj, end = self.raw_decode(s, idx=_w(s, 0).end())
  File "/usr/lib/python2.7/json/decoder.py", line 382, in raw_decode
    raise ValueError("No JSON object could be decoded")
ValueError: No JSON object could be decoded

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-10-01$ ./icmp.sh 
{"changed": true, "rc": 0}
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-10-01$ ./icmp2.sh 
{"failed": true, "msg": "failed to ping", "rc": 1}


robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-10-01$ ~/src/ansible/hacking/test-module -m ./icmp.sh 
* including generated source, if any, saving to: /home/robq/.ansible_module_generated
***********************************
RAW OUTPUT
{"changed": true, "rc": 0}


***********************************
PARSED OUTPUT
{
    "changed": true, 
    "rc": 0
}


robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-10-01$ ~/src/ansible/hacking/test-module -m ./icmp4.sh -a 'target=127.0.0.1'
* including generated source, if any, saving to: /home/robq/.ansible_module_generated
***********************************
RAW OUTPUT
{"changed": true, "rc": 0}


***********************************
PARSED OUTPUT
{
    "changed": true, 
    "rc": 0
}
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-10-01$ ~/src/ansible/hacking/test-module -m ./icmp4.sh -a 'target=128.0.0.1'
* including generated source, if any, saving to: /home/robq/.ansible_module_generated
***********************************
RAW OUTPUT
{"failed": true, "msg": "failed to ping", "rc": 1}


***********************************
PARSED OUTPUT
{
    "failed": true, 
    "msg": "failed to ping", 
    "rc": 1
}

# In a New Terminal Window Run:
watch --differences 'ps -ef | grep ansible | grep -v grep'

# Now run your test module again
~/src/ansible/hacking/test-module -m ./icmp4.sh -a 'target=128.0.0.1'

# 2nd Terminal Watch Output

Every 2.0s: ps -ef | grep ansible | grep -v grep      robq-VirtualBox: Tue Jan 14 22:12:13 2020

robq     11956 13507  8 22:12 pts/0    00:00:00 python /home/robq/src/ansible/hacking/test-modu
robq     11963 11956  0 22:12 pts/0    00:00:00 /bin/sh -c /home/robq/.ansible_module_generated
robq     11964 11963  0 22:12 pts/0    00:00:00 /bin/bash /home/robq/.ansible_module_generated

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-10-01$ a-p icmp_playbook5.yml 

PLAY [linux] ************************************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************************
fatal: [ubuntu2]: FAILED! => {"msg": "Attempting to decrypt but no vault secrets found"}
ok: [centos2]

TASK [Test icmp module] *************************************************************************************************************************************************************************
changed: [centos2]

PLAY RECAP **************************************************************************************************************************************************************************************
centos2                    : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ubuntu2                    : ok=0    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0   

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-10-01$ a-p icmp_fail_playbook5.yml 

PLAY [linux] ************************************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************************
fatal: [ubuntu2]: FAILED! => {"msg": "Attempting to decrypt but no vault secrets found"}
ok: [centos2]

TASK [Test icmp module] *************************************************************************************************************************************************************************
fatal: [centos2]: FAILED! => {"changed": false, "msg": "failed to ping", "rc": 1}

PLAY RECAP **************************************************************************************************************************************************************************************
centos2                    : ok=1    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0   
ubuntu2                    : ok=0    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0

https://docs.ansible.com/ansible/latest/dev_guide/developing_modules_general.html

## Section 3 - 11. Creating Plugins

- Creating plugins
- The various types of plugins that are available
- Custom directory locations for plugins
- How to create a lookup plugin
- How to create a filter plugin

# Revision 1
wget https://raw.githubusercontent.com/ansible/ansible/devel/lib/ansible/plugins/lookup/items.py

# there is already a pre-edited version called sorted_items.py

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-11-01$ a-p sorted_items_playbook.yml 

PLAY [centos2] **********************************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************************
ok: [centos2]

TASK [loop through list] ************************************************************************************************************************************************************************
ok: [centos2] => (item=1) => {
    "msg": "An item: 1"
}
ok: [centos2] => (item=2) => {
    "msg": "An item: 2"
}
ok: [centos2] => (item=3) => {
    "msg": "An item: 3"
}
ok: [centos2] => (item=A) => {
    "msg": "An item: A"
}
ok: [centos2] => (item=M) => {
    "msg": "An item: M"
}
ok: [centos2] => (item=Z) => {
    "msg": "An item: Z"
}

PLAY RECAP **************************************************************************************************************************************************************************************
centos2                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   


# Revision 2
wget https://raw.githubusercontent.com/ansible/ansible/devel/lib/ansible/plugins/filter/core.py

# there is already a pre-edited version called reverse_upper.py

# test the python is valid
python lookup_plugins/reverse_upper.py

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-11-01/filter_plugins$ python
Python 2.7.15+ (default, Oct  7 2019, 17:39:04) 
[GCC 7.4.0] on linux2
Type "help", "copyright", "credits" or "license" for more information.
>>> from reverse_upper import reverse_upper
>>> print(reverse_upper)
<function reverse_upper at 0x7fa9a22fb1b8>
>>> reverse_upper('quackers yo yo')
'OY OY SREKCAUQ'
>>> 

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-11-01$ a-p reverse_upper_filter_playbook.yml 
 [WARNING]: Skipping plugin (/home/robq/mastering-ansible/ansible/playbooks/03-11-01/filter_plugins/core.py) as it seems to be invalid: cannot import name recursive_check_defined


PLAY [all] **************************************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************************
fatal: [ubuntu2]: FAILED! => {"msg": "Attempting to decrypt but no vault secrets found"}
ok: [centos2]

TASK [Reverse and upper ansible_distribution] ***************************************************************************************************************************************************
ok: [centos2] => {
    "msg": "Reverse and upper of ansible_distribution: SOTNEC"
}

TASK [Gathering Facts] **************************************************************************************************************************************************************************
ok: [robq-VirtualBox]

TASK [Reverse and upper ansible_distribution] ***************************************************************************************************************************************************
ok: [robq-VirtualBox] => {
    "msg": "Reverse and upper of ansible_distribution: TNIM XUNIL"
}

PLAY RECAP **************************************************************************************************************************************************************************************
centos2                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
robq-VirtualBox            : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ubuntu2                    : ok=0    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0   

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/03-11-01$ 

## Section 4. Structuring Ansible Playbooks

- Using includes and imports
- Using tags
- Using Roles

## Section 4 - 1. Using includes and Imports

- Using includes and imports
  - include tasks
  - include playbooks
  - include_tasks
  - import_playbook
  - import_tasks

# Output for Section-04 

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/04-01/Section-04$ a-p include_import_playbook.yml 

PLAY [centos2] **********************************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************************
ok: [centos2]

TASK [debug] ************************************************************************************************************************************************************************************
ok: [centos2] => {
    "msg": "===================== Testing include_tasks ====================="
}
included: /home/robq/mastering-ansible/ansible/playbooks/04-01/Section-04/include_tasks.yml for centos2

TASK [set_fact] *********************************************************************************************************************************************************************************
ok: [centos2]

TASK [2nd Task] *********************************************************************************************************************************************************************************
ok: [centos2] => {
    "msg": "2nd Task"
}

TASK [3rd Task] *********************************************************************************************************************************************************************************
ok: [centos2] => {
    "msg": "3rd Task"
}

TASK [debug] ************************************************************************************************************************************************************************************
ok: [centos2] => {
    "msg": "======================== Testing include ========================"
}

TASK [set_fact] *********************************************************************************************************************************************************************************
ok: [centos2]

TASK [2nd Task] *********************************************************************************************************************************************************************************
skipping: [centos2]

TASK [3rd Task] *********************************************************************************************************************************************************************************
skipping: [centos2]

TASK [debug] ************************************************************************************************************************************************************************************
ok: [centos2] => {
    "msg": "===================== Testing import_tasks ======================"
}

TASK [set_fact] *********************************************************************************************************************************************************************************
ok: [centos2]

TASK [2nd Task] *********************************************************************************************************************************************************************************
skipping: [centos2]

TASK [3rd Task] *********************************************************************************************************************************************************************************
skipping: [centos2]

PLAY RECAP **************************************************************************************************************************************************************************************
centos2                    : ok=10   changed=0    unreachable=0    failed=0    skipped=4    rescued=0    ignored=0

# Summary of Section-04 - 'Static vs Dynamic in Tasks'

- include_tasks = Dynamic
- include = Static - by default, can be made Dynamic
- import_tasks = Static
- Dynamic - directives applied at execution, that is when applies in the same
  way to every task at the point of the inclusion, changes to variables, do not
  affect the inclusion state
- Static - directives applied at execution, that is when are actioned sequentially
  for each task


# re-Output of Section-04 making static = false making it Dynamic

included: /home/robq/mastering-ansible/ansible/playbooks/04-01/Section-04/include.yml for centos2

TASK [set_fact] *********************************************************************************************************************************************************************************
ok: [centos2]

TASK [2nd Task] *********************************************************************************************************************************************************************************
ok: [centos2] => {
    "msg": "2nd Task"
}

TASK [3rd Task] *********************************************************************************************************************************************************************************
ok: [centos2] => {
    "msg": "3rd Task"
}

TASK [debug] ************************************************************************************************************************************************************************************
ok: [centos2] => {
    "msg": "===================== Testing import_tasks ======================"
}

TASK [set_fact] *********************************************************************************************************************************************************************************
ok: [centos2]

TASK [2nd Task] *********************************************************************************************************************************************************************************
skipping: [centos2]

TASK [3rd Task] *********************************************************************************************************************************************************************************
skipping: [centos2]

PLAY RECAP **************************************************************************************************************************************************************************************
centos2                    : ok=13   changed=0    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/04-01/Section-04$ gdf
diff --git a/ansible/playbooks/04-01/Section-04/include_import_playbook.yml b/ansible/playbooks/04-01/Section-04/include_import_playbook.yml
index ef71b94..8bcb6dd 100644
--- a/ansible/playbooks/04-01/Section-04/include_import_playbook.yml
+++ b/ansible/playbooks/04-01/Section-04/include_import_playbook.yml
@@ -31,7 +31,7 @@
      # the when condition
      - include: include.yml
        when: include_var is not defined
-       #static: false
+       static: false
 
      - debug:
          msg: ===================== Testing import_tasks ======================


# Summary of Section-05 - 'Static vs Dynamic in Tasks'

- include = Deprecated
- include_* = Dynamic
- import_* = Static
- Dynamic - directives applied at execution, that is when applies in the same
  way to every task at the point of the inclusion, changes to variables, do not
  affect the inclusion state
- Static - directives applied at execution, that is when are actioned sequentially
  for each task

# Extra Summary

- include_* = Dynamic - Can be used with loops
- import_* = Static - Cannot be used with loops

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/04-01/Section-06$ a-p include_loop_playbook.yml 
ERROR! You cannot use loops on 'import_tasks' statements. You should use 'include_tasks' instead.

The error appears to be in '/home/robq/mastering-ansible/ansible/playbooks/04-01/Section-06/include_loop_playbook.yml': line 16, column 8, but may
be elsewhere in the file depending on the exact syntax problem.

The offending line appears to be:

     #- include_tasks: include_tasks.yml
     - import_tasks: include_tasks.yml
       ^ here

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/04-01/Section-06$ gdf
diff --git a/ansible/playbooks/04-01/Section-06/include_loop_playbook.yml b/ansible/playbooks/04-01/Section-06/include_loop_playbook.yml
index e87bccb..41be7b9 100644
--- a/ansible/playbooks/04-01/Section-06/include_loop_playbook.yml
+++ b/ansible/playbooks/04-01/Section-06/include_loop_playbook.yml
@@ -6,13 +6,14 @@
 -
 
   # Target: where our play will run and options it will run with
-  hosts: centos1
+  hosts: centos2
 
   # Task: the list of tasks that will be executed within the play, this section
   # can also be used for pre and post tasks
   tasks:
 
-     - include_tasks: include_tasks.yml
+     #- include_tasks: include_tasks.yml
+     - import_tasks: include_tasks.yml
        with_items: [1, 2, 3]
 
 # Three dots indicate the end of a YAML document


## Section 4 - 2. Using Tags

- Using tags
- Segmentation with tags
- Execution with tags
- Skipping with tags
- Playbook tags
- Special tags
- Tag inheritance

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/04-02/01$ grep -A1 tags nginx_playbook.yml | grep ' - ' | uniq
        - install-epel
        - install-nginx
        - patch-nginx
        - nginx-template
        - nginx-running
        - nginx-open-firewall

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/04-02/01$ a-p nginx_playbook.yml --tags 'install-nginx,patch-nginx'

PLAY [ubuntu,centos] ****************************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************************
ok: [ubuntu2]
ok: [centos2]

TASK [Install Nginx] ****************************************************************************************************************************************************************************
 [WARNING]: Could not find aptitude. Using apt-get instead

ok: [ubuntu2]

TASK [Install Patch] ****************************************************************************************************************************************************************************
skipping: [ubuntu2]

TASK [Patch nginx.conf to include sites-available, disable default server entry] ****************************************************************************************************************
skipping: [ubuntu2]

TASK [Create /etc/nginx/sites-available directory if required] **********************************************************************************************************************************
ok: [ubuntu2]

TASK [Create /etc/nginx/sites-enabled directory if required] ************************************************************************************************************************************
ok: [ubuntu2]

TASK [Copy default nginx configuration] *********************************************************************************************************************************************************
ok: [ubuntu2]

TASK [Symbolic link /etc/nginx/sites-available/default to /etc/nginx/sites-enabled/default] *****************************************************************************************************
ok: [ubuntu2]

TASK [Create nginx/html directory if required] **************************************************************************************************************************************************
ok: [ubuntu2]

TASK [Install Nginx] ****************************************************************************************************************************************************************************
ok: [centos2]

TASK [Install Patch] ****************************************************************************************************************************************************************************
changed: [centos2]

TASK [Patch nginx.conf to include sites-available, disable default server entry] ****************************************************************************************************************
ok: [centos2]

TASK [Create /etc/nginx/sites-available directory if required] **********************************************************************************************************************************
ok: [centos2]

TASK [Create /etc/nginx/sites-enabled directory if required] ************************************************************************************************************************************
ok: [centos2]

TASK [Copy default nginx configuration] *********************************************************************************************************************************************************
ok: [centos2]

TASK [Symbolic link /etc/nginx/sites-available/default to /etc/nginx/sites-enabled/default] *****************************************************************************************************
ok: [centos2]

TASK [Create nginx/html directory if required] **************************************************************************************************************************************************
ok: [centos2]

PLAY RECAP **************************************************************************************************************************************************************************************
centos2                    : ok=9    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ubuntu2                    : ok=7    changed=0    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/04-02/01$ a-p nginx_playbook.yml --skip-tags 'patch-nginx'

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/04-02/04$ for tag in include_tasks_deprecated include_tasks include_playbook import_playbook; do echo Testing ${tag}; ansible-playbook include_import_playbook.yml --tag ${tag}; done
Testing include_tasks_deprecated
ERROR! A malformed block was encountered while loading a block
Testing include_tasks
ERROR! A malformed block was encountered while loading a block
Testing include_playbook
ERROR! A malformed block was encountered while loading a block
Testing import_playbook
ERROR! A malformed block was encountered while loading a block

# will come back to this piece of $h1te ;-)

## Section 4 - 3. Using Roles

- Using roles
- The role structure
- How to create roles with Ansible Galaxy
- How to move an existing project to a role
- How to set role dependencies

-- Benefits of using Roles
- Larger projects, are made easier to manage
- Roles are grouped with logical structure, making them easier to share
- Roles can be written to target specific requirements for example a webserver
  role, a DNS server role, a patching role
- Roles can be developed independently, in parrallel by different entities and
  work well with version control systems
- Template, vars and files, have designated directories and inclusion is
  simplified
- Roles, can have dependencies on other roles, allowing automatic inclusion

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/04-03/01$ tree
.
├── ansible.cfg
├── files
│   ├── nginx.conf.centos.patch
│   └── nginx-default.conf
├── group_vars
│   ├── centos
│   ├── dns
│   └── ubuntu
├── hosts.yml
├── host_vars
│   ├── centos1
│   └── robq-VirtualBox
├── nginx_playbook.yml
└── templates
    └── index.html.j2

4 directories, 11 files
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/04-03/01$ a-p nginx_playbook.yml --skip-tags 'install-epel,install-nginx,patch-nginx'

PLAY [ubuntu,centos] ****************************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************************
ok: [ubuntu2]

TASK [Template index.html.j2 to index.html on target] *******************************************************************************************************************************************
ok: [ubuntu2]

TASK [Restart nginx] ****************************************************************************************************************************************************************************
changed: [ubuntu2]

TASK [Open CentOS firewall for Nginx] ***********************************************************************************************************************************************************
skipping: [ubuntu2]

RUNNING HANDLER [Check HTTP Service] ************************************************************************************************************************************************************
ok: [ubuntu2]

TASK [Gathering Facts] **************************************************************************************************************************************************************************
ok: [centos2]

TASK [Template index.html.j2 to index.html on target] *******************************************************************************************************************************************
ok: [centos2]

TASK [Restart nginx] ****************************************************************************************************************************************************************************
changed: [centos2]

TASK [Open CentOS firewall for Nginx] ***********************************************************************************************************************************************************
ok: [centos2]

RUNNING HANDLER [Check HTTP Service] ************************************************************************************************************************************************************
ok: [centos2]

PLAY RECAP **************************************************************************************************************************************************************************************
centos2                    : ok=5    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ubuntu2                    : ok=4    changed=1    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/04-03/01$ a-g init nginx
- nginx was created successfully
robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/04-03/01$ tree nginx
nginx
├── defaults
│   └── main.yml
├── files
├── handlers
│   └── main.yml
├── meta
│   └── main.yml
├── README.md
├── tasks
│   └── main.yml
├── templates
├── tests
│   ├── inventory
│   └── test.yml
└── vars
    └── main.yml

8 directories, 8 files

-- Transition Strategy
- Move the handlers of the playbook, into handlers/main.yml
- Move the existing templates into templates and remove the old directory
- Move the existing files into files and again, remove the old directory
- We don't have specific vars in the playbook for this, but, we do currently have
  the logos in the group vars files, move these into vars/main.yml
- Move the playbook tasks, to tasks/main.yml
- As we have moved the files into the roles, we no longer need to specify the
  directory, so remove files and templates references accordingly
- Finally, update our playbook so it just contains the role

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/04-03/02$ tree
.
├── ansible.cfg
├── group_vars
│   ├── centos
│   ├── dns
│   └── ubuntu
├── hosts.yml
├── host_vars
│   ├── centos1
│   └── robq-VirtualBox
├── nginx
│   ├── defaults
│   │   └── main.yml
│   ├── files
│   │   ├── nginx.conf.centos.patch
│   │   └── nginx-default.conf
│   ├── handlers
│   │   └── main.yml
│   ├── meta
│   │   └── main.yml
│   ├── README.md
│   ├── tasks
│   │   └── main.yml
│   ├── templates
│   │   └── index.html.j2
│   ├── tests
│   │   ├── inventory
│   │   └── test.yml
│   └── vars
│       └── main.yml
└── nginx_playbook.yml

11 directories, 19 files

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/04-03/02$ a-p nginx_playbook.yml --skip-tags 'install-epel,install-nginx,patch-nginx'

PLAY [ubuntu,centos] ****************************************************************************************************************************************************************************

TASK [Gathering Facts] **************************************************************************************************************************************************************************
ok: [ubuntu2]

TASK [nginx : Template index.html.j2 to index.html on target] ***********************************************************************************************************************************
ok: [ubuntu2]

TASK [nginx : Restart nginx] ********************************************************************************************************************************************************************
changed: [ubuntu2]

TASK [nginx : Open CentOS firewall for Nginx] ***************************************************************************************************************************************************
skipping: [ubuntu2]

RUNNING HANDLER [nginx : Check HTTP Service] ****************************************************************************************************************************************************
ok: [ubuntu2]

TASK [Gathering Facts] **************************************************************************************************************************************************************************
ok: [centos2]

TASK [nginx : Template index.html.j2 to index.html on target] ***********************************************************************************************************************************
ok: [centos2]

TASK [nginx : Restart nginx] ********************************************************************************************************************************************************************
changed: [centos2]

TASK [nginx : Open CentOS firewall for Nginx] ***************************************************************************************************************************************************
ok: [centos2]

RUNNING HANDLER [nginx : Check HTTP Service] ****************************************************************************************************************************************************
ok: [centos2]

PLAY RECAP **************************************************************************************************************************************************************************************
centos2                    : ok=5    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ubuntu2                    : ok=4    changed=1    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   

robq@robq-VirtualBox:~/mastering-ansible/ansible/playbooks/04-03/02$ 